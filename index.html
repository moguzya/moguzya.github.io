<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Titan AI - Yacht Design</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #login-page {
            background-image: url('https://images.unsplash.com/photo-1599723462412-5a53a451b6d0?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        #main-app {
            background-color: #111827; /* Dark Gray */
        }
        .chat-bubble-user {
            background-color: #3B82F6; /* Blue 500 */
            color: white;
        }
        .chat-bubble-ai {
            background-color: #1F2937; /* Gray 800 */
            color: #E5E7EB; /* Gray 200 */
        }
        #viewer-3d {
            width: 100%;
            height: 100%;
            min-height: 400px;
            border-radius: 0.5rem;
            background: #1F2937;
        }
        #chat-resizer {
            width: 100%;
            height: 10px;
            cursor: ns-resize;
            background-color: #374151; /* Gray-700 */
            border-top: 1px solid #4b5563; /* Gray-600 */
            border-bottom: 1px solid #4b5563; /* Gray-600 */
        }
        
        /* Enhanced Project Navigation Styles */
        .project-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.75rem;
            background: rgba(55, 65, 81, 0.3);
            border: 1px solid rgba(75, 85, 99, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .project-item:hover {
            background: rgba(75, 85, 99, 0.5);
            border-color: rgba(107, 114, 128, 0.6);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .project-item.active {
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            border-color: #2563EB;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }
        
        .project-thumbnail {
            width: 50px;
            height: 38px;
            border-radius: 0.375rem;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
            background: #1F2937;
        }
        
        .project-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .project-item:hover .project-thumbnail img {
            transform: scale(1.1);
        }
        
        .project-info {
            flex: 1;
            margin-left: 0.75rem;
            min-width: 0;
        }
        
        .project-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: #E5E7EB;
            line-height: 1.2;
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .project-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #9CA3AF;
        }
        
        .project-badge {
            background: rgba(34, 197, 94, 0.2);
            color: #22C55E;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.625rem;
            font-weight: 500;
        }
        
        .project-badge.in-progress {
            background: rgba(251, 191, 36, 0.2);
            color: #FBBF24;
        }
        
        .project-badge.concept {
            background: rgba(139, 92, 246, 0.2);
            color: #8B5CF6;
        }
        
        /* Header Styles */
        .app-header {
            background: linear-gradient(135deg, #1F2937 0%, #111827 100%);
            border-bottom: 1px solid #374151;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .breadcrumb-separator {
            color: #6B7280;
            margin: 0 0.5rem;
        }
        
        .header-button {
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.3);
            color: #E5E7EB;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .header-button:hover {
            background: rgba(75, 85, 99, 0.7);
            border-color: rgba(107, 114, 128, 0.5);
            transform: translateY(-1px);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: rgba(55, 65, 81, 0.3);
            border-radius: 0.75rem;
            border: 1px solid rgba(75, 85, 99, 0.3);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        /* Enhanced Viewer Controls */
        .viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .viewer-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .viewer-action-btn {
            background: rgba(55, 65, 81, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.3);
            color: #E5E7EB;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .viewer-action-btn:hover {
            background: rgba(75, 85, 99, 0.7);
            border-color: #3B82F6;
            color: #60A5FA;
        }
        
        .viewer-action-btn.active {
            background: #3B82F6;
            border-color: #2563EB;
            color: white;
        }
        
        /* Resource Information Panel */
        .resource-panel {
            position: absolute;
            top: 0;
            right: -320px;
            width: 320px;
            height: 100%;
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(10px);
            border-left: 1px solid #374151;
            transition: right 0.3s ease;
            z-index: 10;
            overflow-y: auto;
        }
        
        .resource-panel.open {
            right: 0;
        }
        
        .resource-panel-header {
            padding: 1.5rem;
            border-bottom: 1px solid #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .resource-panel-close {
            background: none;
            border: none;
            color: #9CA3AF;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: color 0.2s ease;
        }
        
        .resource-panel-close:hover {
            color: #E5E7EB;
        }
        
        .resource-section {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(55, 65, 81, 0.5);
        }
        
        .resource-section:last-child {
            border-bottom: none;
        }
        
        .resource-section h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #E5E7EB;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .spec-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .spec-item {
            background: rgba(55, 65, 81, 0.3);
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(75, 85, 99, 0.2);
        }
        
        .spec-label {
            font-size: 0.75rem;
            color: #9CA3AF;
            margin-bottom: 0.25rem;
        }
        
        .spec-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: #E5E7EB;
        }
        
        .file-list {
            space-y: 0.5rem;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: rgba(55, 65, 81, 0.3);
            border-radius: 0.5rem;
            border: 1px solid rgba(75, 85, 99, 0.2);
            margin-bottom: 0.5rem;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: #E5E7EB;
            margin-bottom: 0.25rem;
        }
        
        .file-size {
            font-size: 0.75rem;
            color: #9CA3AF;
        }
        
        .download-btn {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .download-btn:hover {
            background: #2563EB;
        }
        
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #374151 25%, #4B5563 50%, #374151 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        
        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        .skeleton-text {
            height: 1rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
        
        .skeleton-text.short {
            width: 60%;
        }
        
        .skeleton-text.medium {
            width: 80%;
        }
        
        .skeleton-text.long {
            width: 100%;
        }
        
        /* Micro-animations */
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        .animate-bounce-in {
            animation: bounceIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes bounceIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Focus States for Accessibility */
        .focus-ring:focus {
            outline: 2px solid #3B82F6;
            outline-offset: 2px;
        }
        
        /* Mobile Sidebar Toggle */
        .sidebar-toggle {
            display: none;
        }
        
        /* Image Gallery Styles */
        
        .view-mode-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .view-mode-btn {
            padding: 0.5rem 1.25rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            border: 1px solid #374151;
            background: #1F2937;
            color: #E5E7EB;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .view-mode-btn:hover {
            background: #374151;
            border-color: #4B5563;
        }
        
        .view-mode-btn.active {
            background: #3B82F6;
            border-color: #2563EB;
            color: white;
        }
        
        .image-gallery {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 1rem;
            width: 100%;
        }
        
        .gallery-main-image {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #111827;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
            min-height: 400px;
            width: 100%;
        }
        
        .gallery-main-image img,
        .gallery-main-image video {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            cursor: zoom-in;
            transition: transform 0.2s ease-in-out;
        }
        
        .gallery-main-image img:hover {
            transform: scale(1.02);
        }
        
        .gallery-thumbnails {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            padding: 0.5rem;
            background: rgba(31, 41, 55, 0.5);
            border-radius: 0.375rem;
            backdrop-filter: blur(5px);
        }
        
        .gallery-thumbnail {
            width: 80px;
            height: 60px;
            border-radius: 0.375rem;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
            position: relative;
        }
        
        .gallery-thumbnail:hover {
            border-color: #6B7280;
            transform: scale(1.05);
        }
        
        .gallery-thumbnail.active {
            border-color: #3B82F6;
            box-shadow: 0 0 0 1px #3B82F6;
        }
        
        .gallery-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .gallery-thumbnail .thumbnail-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        
        .gallery-thumbnail:hover .thumbnail-overlay {
            opacity: 1;
        }
        
        .gallery-thumbnail.animation::after {
            content: "â–¶";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        /* Lightbox Styles */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }
        
        .lightbox.active {
            opacity: 1;
            visibility: visible;
        }
        
        .lightbox-content {
            max-width: 90vw;
            max-height: 90vh;
            position: relative;
        }
        
        .lightbox-image,
        .lightbox-video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
        }
        
        .lightbox-close {
            position: absolute;
            top: -3rem;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 2rem;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease-in-out;
        }
        
        .lightbox-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 2rem;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease-in-out;
        }
        
        .lightbox-nav:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .lightbox-prev {
            left: -4rem;
        }
        
        .lightbox-next {
            right: -4rem;
        }
        
        .lightbox-info {
            position: absolute;
            bottom: -3rem;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        /* Loading and Error States */
        .gallery-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #9CA3AF;
        }
        
        .gallery-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #EF4444;
            text-align: center;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 1024px) {
            .resource-panel {
                width: 280px;
                right: -280px;
            }
        }
        
        @media (max-width: 768px) {
            .project-item {
                padding: 0.5rem;
            }
            
            .project-thumbnail {
                width: 40px;
                height: 30px;
            }
            
            .project-info {
                margin-left: 0.5rem;
            }
            
            .project-name {
                font-size: 0.75rem;
            }
            
            .project-meta {
                font-size: 0.625rem;
            }
            
            .view-mode-buttons {
                gap: 0.25rem;
                flex-wrap: wrap;
            }
            
            .view-mode-btn {
                padding: 0.375rem 1rem;
                font-size: 0.75rem;
            }
            
            .gallery-thumbnails {
                gap: 0.25rem;
            }
            
            .gallery-thumbnail {
                width: 60px;
                height: 45px;
            }
            
            .lightbox-close,
            .lightbox-nav {
                width: 2.5rem;
                height: 2.5rem;
                font-size: 1.5rem;
            }
            
            .lightbox-prev {
                left: -3rem;
            }
            
            .lightbox-next {
                right: -3rem;
            }
            
            .resource-panel {
                width: 100%;
                right: -100%;
            }
            
            .viewer-actions {
                flex-wrap: wrap;
                gap: 0.25rem;
            }
            
            .viewer-action-btn {
                padding: 0.375rem;
            }
            
            .sidebar-toggle {
                display: block;
            }
            
            #sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                z-index: 50;
                transition: left 0.3s ease;
                width: 280px;
            }
            
            #sidebar.open {
                left: 0;
            }
            
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }
            
            .sidebar-overlay.active {
                display: block;
            }
            
            #main-content {
                width: 100%;
            }
        }
        
        /* Animation for smooth transitions */
        .viewer-transition {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        
        .viewer-transition.fade-out {
            opacity: 0;
            transform: scale(0.95);
        }
        
        .viewer-transition.fade-in {
            opacity: 1;
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white select-none">

    <!-- Login Page -->
    <div id="login-page" class="h-screen w-screen flex items-center justify-center">
        <div class="glassmorphism p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
            <h1 class="text-5xl font-bold text-white mb-2">The Titan AI</h1>
            <p class="text-gray-200 mb-8">The Future of Yacht Design</p>
            <form id="login-form" class="space-y-6">
                <div>
                    <input type="text" id="username" placeholder="Username" class="w-full bg-white/20 text-white placeholder-gray-300 p-3 rounded-lg border border-transparent focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
                </div>
                <div>
                    <input type="password" id="password" placeholder="Password" class="w-full bg-white/20 text-white placeholder-gray-300 p-3 rounded-lg border border-transparent focus:outline-none focus:ring-2 focus:ring-blue-400 transition">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg">Login</button>
                <p id="login-error" class="text-red-400 text-sm pt-2"></p>
            </form>
        </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <!-- Main Application -->
    <div id="main-app" class="hidden h-screen w-screen flex flex-col">
        <!-- Header -->
        <header class="app-header px-4 py-3 flex items-center justify-between flex-shrink-0">
            <div class="flex items-center gap-4">
                <!-- Mobile Sidebar Toggle -->
                <button id="sidebar-toggle" class="sidebar-toggle header-button md:hidden focus-ring">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                
                <div class="flex items-center gap-2">
                    <img src="http://googleusercontent.com/file_content/1" alt="Titan AI Logo" class="h-8 w-auto">
                    <h1 class="text-xl font-bold text-white">Titan AI</h1>
                </div>
                
                <!-- Breadcrumbs -->
                <nav id="breadcrumbs" class="hidden md:flex items-center text-sm">
                    <span class="text-gray-400">Design Studio</span>
                    <span class="breadcrumb-separator">â€º</span>
                    <span id="current-project" class="text-gray-300">Select Project</span>
                </nav>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- Quick Actions -->
                <div class="hidden md:flex gap-2">
                    <button id="fullscreen-btn" class="header-button focus-ring" title="Toggle Fullscreen">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                    <button id="help-btn" class="header-button focus-ring" title="Help & Shortcuts">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- User Profile -->
                <div class="user-profile">
                    <div class="user-avatar">A</div>
                    <div class="hidden md:block">
                        <div class="text-sm font-medium text-white">Admin</div>
                        <div class="text-xs text-gray-400">Designer</div>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-72 bg-gray-900/80 p-4 flex flex-col h-full border-r border-gray-700 flex-shrink-0 overflow-y-auto">
                <!-- Mobile Close Button -->
                <button id="sidebar-close" class="md:hidden self-end p-2 text-gray-400 hover:text-white mb-4 focus-ring">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                
                <h3 class="text-lg font-semibold text-gray-300 mb-4">Project Gallery</h3>
                <nav id="project-list" class="flex-grow space-y-1 overflow-y-auto">
                    <!-- Enhanced project items will be injected here -->
                </nav>
                <button id="logout-button" class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition duration-300 focus-ring">Logout</button>
            </aside>

            <!-- Main Content -->
            <main id="main-content" class="flex-grow flex flex-col h-full overflow-hidden">
                <!-- Placeholder View -->
                <div id="placeholder-view" class="flex-grow flex items-center justify-center text-gray-500">
                    <div class="text-center animate-fade-in">
                        <svg class="mx-auto h-24 w-24 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                        </svg>
                        <h3 class="mt-2 text-2xl font-medium">Select a project</h3>
                        <p class="mt-1 text-lg">Choose a yacht design from the gallery to explore its details.</p>
                        <div class="mt-4 text-sm text-gray-600">
                            <p>ðŸ’¡ Use keyboard shortcuts: <kbd class="px-2 py-1 bg-gray-800 rounded">1</kbd> <kbd class="px-2 py-1 bg-gray-800 rounded">2</kbd> <kbd class="px-2 py-1 bg-gray-800 rounded">3</kbd> to switch views</p>
                        </div>
                    </div>
                </div>
                
                <!-- Project Detail View -->
                <div id="project-detail-view" class="hidden flex-grow flex flex-col p-6 overflow-hidden relative">
                    <div class="flex-grow flex flex-col gap-6 overflow-hidden">
                        <!-- 2D/3D Viewer -->
                        <div id="viewer-container" class="w-full flex-grow flex flex-col bg-gray-800 rounded-lg p-4 overflow-hidden relative">
                            <div class="viewer-header">
                                <!-- View Mode Controls -->
                                <div class="view-mode-buttons">
                                    <button class="view-mode-btn active focus-ring" data-mode="gallery">
                                        Gallery <kbd class="ml-1 text-xs opacity-75">1</kbd>
                                    </button>
                                    <button class="view-mode-btn focus-ring" data-mode="3d">
                                        3D Model <kbd class="ml-1 text-xs opacity-75">2</kbd>
                                    </button>
                                    <button class="view-mode-btn focus-ring" data-mode="animation">
                                        Animation <kbd class="ml-1 text-xs opacity-75">3</kbd>
                                    </button>
                                </div>
                                
                                <!-- Viewer Actions -->
                                <div class="viewer-actions">
                                    <button id="info-toggle" class="viewer-action-btn focus-ring" title="Toggle Info Panel">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </button>
                                    <button id="share-btn" class="viewer-action-btn focus-ring" title="Share Design">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                        </svg>
                                    </button>
                                    <button id="download-btn" class="viewer-action-btn focus-ring" title="Download Resources">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </button>
                                    <button id="fullscreen-viewer" class="viewer-action-btn focus-ring" title="Fullscreen (F)">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        
                        <div id="viewer-content" class="flex-grow relative viewer-transition">
                            <!-- Traditional 2D Viewer -->
                            <div id="viewer-2d" class="hidden w-full h-full flex items-center justify-center">
                                <img id="design-image" src="" alt="2D Design" class="max-w-full max-h-full rounded-lg object-contain">
                            </div>
                            
                            <!-- Image Gallery -->
                            <div id="viewer-gallery" class="w-full h-full image-gallery">
                                <div class="gallery-main-image">
                                    <img id="gallery-main-img" src="" alt="Yacht Design" class="max-w-full max-h-full hidden">
                                    <div id="gallery-loading" class="gallery-loading">
                                        <svg class="animate-spin h-8 w-8 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        Loading image...
                                    </div>
                                    <div id="gallery-error" class="hidden gallery-error">
                                        <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                        </svg>
                                        <p>Failed to load image</p>
                                    </div>
                                </div>
                                <div id="gallery-thumbnails" class="gallery-thumbnails">
                                    <!-- Thumbnails will be populated by JavaScript -->
                                </div>
                            </div>
                            
                            <!-- Animation Viewer -->
                            <div id="viewer-animation" class="hidden w-full h-full flex items-center justify-center">
                                <img id="animation-image" src="" alt="Yacht Animation" class="max-w-full max-h-full rounded-lg object-contain">
                            </div>
                            
                            <!-- 3D Viewer -->
                            <div id="viewer-3d" class="hidden w-full h-full">
                                <!-- 3D renderer will attach here -->
                            </div>
                            
                            <!-- Loader -->
                            <div id="viewer-loader" class="hidden absolute inset-0 bg-gray-800/80 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="animate-spin h-10 w-10 text-white mx-auto mb-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </div>
                                    <p class="text-lg">Loading 3D Model...</p>
                                    <p class="text-sm text-gray-400 mt-2">Please wait while we prepare your yacht design</p>
                                </div>
                            </div>
                            
                            <!-- Resource Information Panel -->
                            <div id="resource-panel" class="resource-panel">
                                <div class="resource-panel-header">
                                    <h3 class="text-lg font-semibold text-white">Yacht Information</h3>
                                    <button id="resource-panel-close" class="resource-panel-close">&times;</button>
                                </div>
                                
                                <div class="resource-section">
                                    <h4>Specifications</h4>
                                    <div class="spec-grid">
                                        <div class="spec-item">
                                            <div class="spec-label">Length</div>
                                            <div class="spec-value" id="spec-length">--</div>
                                        </div>
                                        <div class="spec-item">
                                            <div class="spec-label">Type</div>
                                            <div class="spec-value" id="spec-type">--</div>
                                        </div>
                                        <div class="spec-item">
                                            <div class="spec-label">Status</div>
                                            <div class="spec-value" id="spec-status">--</div>
                                        </div>
                                        <div class="spec-item">
                                            <div class="spec-label">Designer</div>
                                            <div class="spec-value" id="spec-designer">Titan AI</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="resource-section">
                                    <h4>Available Formats</h4>
                                    <div class="file-list space-y-2">
                                        <div class="file-item">
                                            <div class="file-info">
                                                <div class="file-name">3D Model (.glb)</div>
                                                <div class="file-size">~2.5 MB</div>
                                            </div>
                                            <button class="download-btn" onclick="downloadFile('glb')">Download</button>
                                        </div>
                                        <div class="file-item">
                                            <div class="file-info">
                                                <div class="file-name">3D Print (.stl)</div>
                                                <div class="file-size">~1.8 MB</div>
                                            </div>
                                            <button class="download-btn" onclick="downloadFile('stl')">Download</button>
                                        </div>
                                        <div class="file-item">
                                            <div class="file-info">
                                                <div class="file-name">CAD Format (.fbx)</div>
                                                <div class="file-size">~3.2 MB</div>
                                            </div>
                                            <button class="download-btn" onclick="downloadFile('fbx')">Download</button>
                                        </div>
                                        <div class="file-item">
                                            <div class="file-info">
                                                <div class="file-name">AR Model (.usdz)</div>
                                                <div class="file-size">~2.1 MB</div>
                                            </div>
                                            <button class="download-btn" onclick="downloadFile('usdz')">Download</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="resource-section">
                                    <h4>Textures & Materials</h4>
                                    <div class="space-y-2">
                                        <div class="spec-item">
                                            <div class="spec-label">Resolution</div>
                                            <div class="spec-value">128x128 px</div>
                                        </div>
                                        <div class="spec-item">
                                            <div class="spec-label">Format</div>
                                            <div class="spec-value">PBR Materials</div>
                                        </div>
                                        <div class="file-list space-y-1">
                                            <div class="text-sm text-gray-400">â€¢ Diffuse Map</div>
                                            <div class="text-sm text-gray-400">â€¢ Normal Map</div>
                                            <div class="text-sm text-gray-400">â€¢ Metallic Map</div>
                                            <div class="text-sm text-gray-400">â€¢ Roughness Map</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Resizer Handle -->
                    <div id="chat-resizer"></div>
                    <!-- Chat/Prompt History -->
                    <div id="chat-panel" class="w-full basis-1/2 flex-shrink-0 flex flex-col bg-gray-800 rounded-lg p-4 overflow-hidden">
                        <h3 class="text-xl font-bold mb-4 text-white flex-shrink-0">Design History</h3>
                        <div id="chat-history" class="flex-grow space-y-4 overflow-y-auto pr-2">
                           <!-- Chat messages will be injected here -->
                        </div>
                         <div class="mt-4 flex-shrink-0">
                            <div class="relative">
                                <input type="text" placeholder="Continue the conversation..." class="w-full bg-gray-700 text-white placeholder-gray-400 p-4 pr-24 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                    <button class="text-gray-400 hover:text-blue-400 mr-2">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                                    </button>
                                    <button class="text-gray-400 hover:text-blue-400">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox">
        <div class="lightbox-content">
            <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
            <button class="lightbox-nav lightbox-prev" onclick="navigateLightbox(-1)">&#8249;</button>
            <button class="lightbox-nav lightbox-next" onclick="navigateLightbox(1)">&#8250;</button>
            <img id="lightbox-image" class="lightbox-image" src="" alt="">
            <div id="lightbox-info" class="lightbox-info"></div>
        </div>
    </div>

    <script type="module">
        // Enhanced Mock Data with Metadata
        const yachtData = {
            "yacht1": {
                name: "80ft Luxury Sailing Catamaran",
                length: "80 ft",
                type: "Sailing Catamaran",
                status: "Completed",
                thumbnail: 'resources/yacht1-1.png',
                images: [
                    { url: 'resources/yacht1-1.png', title: 'Original Design', type: 'image' },
                    { url: 'resources/yacht1-2.png', title: 'Blue Sails Variant', type: 'image' },
                    { url: 'resources/yacht1-3.png', title: 'Power Catamaran', type: 'image' },
                    { url: 'resources/yacht1.gif', title: 'Animation', type: 'animation' }
                ],
                modelUrl: 'resources/yacht1.glb',
                history: [
                    { type: 'user', text: "I want an 80-foot luxury sailing catamaran, sleek wave-piercing bows, carbon-fiber mast, white composite hulls, teak walk-around decks, minimalist glass saloon" },
                    { type: 'ai', image: 'resources/yacht1-1.png' },
                    { type: 'user', text: "change sails to vibrant electric-blue gradient with subtle geometric pattern" },
                    { type: 'ai', image: 'resources/yacht1-2.png' },
                    { type: 'user', text: "remove sails to convert into a power catamaran, lengthen central bridge deck and hulls visibly for a faster, sportier profile" },
                    { type: 'ai', image: 'resources/yacht1-3.png' },
                    { type: 'user', text: "Looks great show me 3D" },
                    { type: 'ai', is3D: true, modelUrl: 'resources/yacht1.glb' },
                ]
            },
            "yacht2": {
                name: "60ft Modern Sport Yacht",
                length: "60 ft",
                type: "Sport Yacht",
                status: "In Progress",
                thumbnail: 'resources/yacht2-1.png',
                images: [
                    { url: 'resources/yacht2-1.png', title: 'Pearl White Hull', type: 'image' },
                    { url: 'resources/yacht2-2.png', title: 'Royal Blue Variant', type: 'image' },
                    { url: 'resources/yacht2-3.png', title: 'Extended 70ft Design', type: 'image' },
                    { url: 'resources/yacht2.gif', title: 'Animation', type: 'animation' }
                ],
                modelUrl: 'resources/yacht2.glb',
                history: [
                    { type: 'user', text: "I want a luxury yacht with three-quarter bow view of a 60-foot modern sport yacht, sharp angular lines, low profile, metallic pearl-white hull, tinted wraparound windshield, teak foredeck detailing" },
                    { type: 'ai', image: 'resources/yacht2-1.png' },
                    { type: 'user', text: "change hull color to deep royal blue with silver accent stripe" },
                    { type: 'ai', image: 'resources/yacht2-2.png' },
                    { type: 'user', text: "extend hull to 70 ft, make it visibly longer and slimmer, add sleek integrated solar-panel roof over cockpit" },
                    { type: 'ai', image: 'resources/yacht2-3.png' },
                    { type: 'user', text: "show 3D" },
                    { type: 'ai', is3D: true, modelUrl: 'resources/yacht2.glb' },
                ]
            },
            "yacht3": {
                name: "75ft Expedition Explorer",
                length: "75 ft",
                type: "Explorer Yacht",
                status: "Completed",
                thumbnail: 'resources/yacht3-1.png',
                images: [
                    { url: 'resources/yacht3-1.png', title: 'Light Gray Explorer', type: 'image' },
                    { url: 'resources/yacht3-2.png', title: 'Navy Blue Variant', type: 'image' },
                    { url: 'resources/yacht3-3.png', title: 'Infinity Pool Design', type: 'image' },
                    { url: 'resources/yacht3.gif', title: 'Animation', type: 'animation' }
                ],
                modelUrl: 'resources/yacht3.glb',
                history: [
                    { type: 'user', text: "Design me a 75-foot expedition explorer yacht, robust plumb bow, ice-class hull, matte light-gray paint, aft helipad with folded drone, large rectangular windows, modern radar mast" },
                    { type: 'ai', image: 'resources/yacht3-1.png' },
                    { type: 'user', text: "repaint hull deep navy blue with a thin safety-orange waterline stripe" },
                    { type: 'ai', image: 'resources/yacht3-2.png' },
                    { type: 'user', text: "add an infinity pool on the aft deck, extend superstructure windows into a seamless panoramic glass band" },
                    { type: 'ai', image: 'resources/yacht3-3.png' },
                    { type: 'user', text: "Good, show me 3D" },
                    { type: 'ai', is3D: true, modelUrl: 'resources/yacht3.glb' },
                ]
            },
            "yacht4": {
                name: "50ft Retro Wooden Yacht",
                length: "50 ft",
                type: "Classic Yacht",
                status: "Concept",
                thumbnail: 'resources/yacht4-1.png',
                images: [
                    { url: 'resources/yacht4-1.png', title: 'Mahogany Classic', type: 'image' },
                    { url: 'resources/yacht4-2.png', title: 'Extended Flybridge', type: 'image' },
                    { url: 'resources/yacht4-3.png', title: 'Turquoise Finish', type: 'image' },
                    { url: 'resources/yacht4.gif', title: 'Animation', type: 'animation' }
                ],
                modelUrl: 'resources/yacht4.glb',
                history: [
                    { type: 'user', text: "Give me a 50-foot retro-inspired wooden yacht, curved mahogany topsides, white topside stripe, chrome portholes, classic tumblehome stern, art-deco cabin roof" },
                    { type: 'ai', image: 'resources/yacht4-1.png' },
                    { type: 'user', text: "add a streamlined flybridge, extend the bow by 8 feet for a sleeker silhouette, incorporate subtle winglets near stern" },
                    { type: 'ai', image: 'resources/yacht4-2.png' },
                    { type: 'user', text: "change hull finish to metallic turquoise with polished wood accent trim" },
                    { type: 'ai', image: 'resources/yacht4-3.png' },
                    { type: 'user', text: "Perfect, now make it 3D" },
                    { type: 'ai', is3D: true, modelUrl: 'resources/yacht4.glb' },
                ]
            }
        };

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const projectList = document.getElementById('project-list');
        const placeholderView = document.getElementById('placeholder-view');
        const projectDetailView = document.getElementById('project-detail-view');
        const chatHistory = document.getElementById('chat-history');
        const designImage = document.getElementById('design-image');
        const viewer2D = document.getElementById('viewer-2d');
        const viewer3D = document.getElementById('viewer-3d');
        const viewerGallery = document.getElementById('viewer-gallery');
        const viewerAnimation = document.getElementById('viewer-animation');
        const viewerLoader = document.getElementById('viewer-loader');
        const galleryMainImg = document.getElementById('gallery-main-img');
        const galleryThumbnails = document.getElementById('gallery-thumbnails');
        const galleryLoading = document.getElementById('gallery-loading');
        const galleryError = document.getElementById('gallery-error');
        const animationImage = document.getElementById('animation-image');
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxInfo = document.getElementById('lightbox-info');
        const chatPanel = document.getElementById('chat-panel');
        const chatResizer = document.getElementById('chat-resizer');
        const currentProjectSpan = document.getElementById('current-project');
        const resourcePanel = document.getElementById('resource-panel');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarClose = document.getElementById('sidebar-close');
        
        let threeScene, threeCamera, threeRenderer, threeControls, currentModel;
        let currentProject = null;
        let currentViewMode = 'gallery';
        let currentImageIndex = 0;
        let lightboxIndex = 0;

        // --- MOBILE SIDEBAR FUNCTIONALITY ---
        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('active');
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
        }

        // Mobile sidebar event listeners
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', toggleSidebar);
        }

        if (sidebarClose) {
            sidebarClose.addEventListener('click', closeSidebar);
        }

        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', closeSidebar);
        }

        // --- RESOURCE PANEL FUNCTIONALITY ---
        function toggleResourcePanel() {
            resourcePanel.classList.toggle('open');
        }

        function closeResourcePanel() {
            resourcePanel.classList.remove('open');
        }

        const infoToggle = document.getElementById('info-toggle');
        const resourcePanelClose = document.getElementById('resource-panel-close');

        if (infoToggle) {
            infoToggle.addEventListener('click', toggleResourcePanel);
        }

        if (resourcePanelClose) {
            resourcePanelClose.addEventListener('click', closeResourcePanel);
        }

        // --- KEYBOARD SHORTCUTS ---
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeLightbox();
                closeResourcePanel();
                closeSidebar();
            }
            
            // View mode shortcuts (only when project is loaded)
            if (currentProject && !e.ctrlKey && !e.altKey && !e.metaKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        switchViewMode('gallery');
                        break;
                    case '2':
                        e.preventDefault();
                        switchViewMode('3d');
                        break;
                    case '3':
                        e.preventDefault();
                        switchViewMode('animation');
                        break;
                    case 'f':
                    case 'F':
                        e.preventDefault();
                        toggleFullscreen();
                        break;
                    case 'i':
                    case 'I':
                        e.preventDefault();
                        toggleResourcePanel();
                        break;
                }
            }
        });

        // --- FULLSCREEN FUNCTIONALITY ---
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const fullscreenViewer = document.getElementById('fullscreen-viewer');

        if (fullscreenBtn) {
            fullscreenBtn.addEventListener('click', toggleFullscreen);
        }

        if (fullscreenViewer) {
            fullscreenViewer.addEventListener('click', toggleFullscreen);
        }

        // --- DOWNLOAD FUNCTIONALITY ---
        window.downloadFile = function(format) {
            if (!currentProject) return;
            
            const projectId = Object.keys(yachtData).find(key => yachtData[key] === currentProject);
            if (!projectId) return;
            
            const filename = `${projectId}.${format}`;
            const url = `resources/${filename}`;
            
            // Create temporary download link
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- SHARE FUNCTIONALITY ---
        const shareBtn = document.getElementById('share-btn');
        if (shareBtn) {
            shareBtn.addEventListener('click', () => {
                if (!currentProject) return;
                
                if (navigator.share) {
                    navigator.share({
                        title: `${currentProject.name} - Yacht Design`,
                        text: `Check out this yacht design: ${currentProject.name}`,
                        url: window.location.href
                    });
                } else {
                    // Fallback: copy URL to clipboard
                    navigator.clipboard.writeText(window.location.href);
                    // Show feedback (you could add a toast notification here)
                    shareBtn.style.color = '#22C55E';
                    setTimeout(() => {
                        shareBtn.style.color = '';
                    }, 1000);
                }
            });
        }

        // --- HELP FUNCTIONALITY ---
        const helpBtn = document.getElementById('help-btn');
        if (helpBtn) {
            helpBtn.addEventListener('click', () => {
                alert(`Keyboard Shortcuts:
                
1, 2, 3 - Switch between Gallery, 3D, and Animation views
F - Toggle fullscreen
I - Toggle info panel
ESC - Close modals/panels

Mouse Controls (3D View):
- Left click + drag: Rotate
- Scroll wheel: Zoom in/out
- Click on images: Open lightbox`);
            });
        }

        // --- UPDATE RESOURCE PANEL INFO ---
        function updateResourcePanel(project) {
            if (!project) return;
            
            document.getElementById('spec-length').textContent = project.length || '--';
            document.getElementById('spec-type').textContent = project.type || '--';
            document.getElementById('spec-status').textContent = project.status || '--';
        }

        // --- AUTHENTICATION ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'admin' && password === 'admin') {
                loginPage.classList.add('hidden');
                mainApp.classList.remove('hidden');
                populateProjectList();
            } else {
                loginError.textContent = 'Invalid credentials. Please try again.';
            }
        });

        logoutButton.addEventListener('click', () => {
            mainApp.classList.add('hidden');
            loginPage.classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            loginError.textContent = '';
            showPlaceholderView();
        });
        
        // --- CHAT RESIZER LOGIC ---
        let isResizing = false;
        chatResizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', () => {
                isResizing = false;
                document.removeEventListener('mousemove', handleMouseMove);
            });
        });

        function handleMouseMove(e) {
            if (!isResizing) return;
            const mainContent = document.getElementById('project-detail-view');
            const totalHeight = mainContent.clientHeight;
            const newChatHeight = totalHeight - (e.clientY - mainContent.getBoundingClientRect().top);

            const minHeight = 150; // 150px
            const maxHeight = totalHeight - 300; // a reasonable max height

            if (newChatHeight > minHeight && newChatHeight < maxHeight) {
                const newChatBasis = (newChatHeight / totalHeight) * 100;
                chatPanel.style.flexBasis = `${newChatBasis}%`;
            }
        }

        // --- GALLERY FUNCTIONALITY ---
        function switchViewMode(mode) {
            if (!currentProject) return;
            
            // Update button states
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });
            
            currentViewMode = mode;
            
            // Hide all viewers
            viewer2D.classList.add('hidden');
            viewer3D.classList.add('hidden');
            viewerGallery.classList.add('hidden');
            viewerAnimation.classList.add('hidden');
            viewerLoader.classList.add('hidden');
            
            // Show appropriate viewer
            switch (mode) {
                case 'gallery':
                    viewerGallery.classList.remove('hidden');
                    populateGallery(currentProject);
                    break;
                case '3d':
                    show3DView(currentProject.modelUrl);
                    break;
                case 'animation':
                    showAnimationView(currentProject);
                    break;
            }
        }
        
        function populateGallery(project) {
            console.log('Populating gallery for project:', project);
            if (!project.images || project.images.length === 0) {
                console.log('No images found for project');
                return;
            }
            
            const staticImages = project.images.filter(img => img.type === 'image');
            console.log('Static images found:', staticImages);
            if (staticImages.length === 0) {
                console.log('No static images found');
                return;
            }
            
            // Set the first image as main
            currentImageIndex = 0;
            console.log('Loading main image:', staticImages[0]);
            loadGalleryMainImage(staticImages[0].url, staticImages[0].title);
            
            // Populate thumbnails
            galleryThumbnails.innerHTML = '';
            staticImages.forEach((image, index) => {
                const thumbnail = createThumbnail(image, index, false);
                galleryThumbnails.appendChild(thumbnail);
            });
            
            // Add animation thumbnail if available
            const animationImage = project.images.find(img => img.type === 'animation');
            if (animationImage) {
                const animThumbnail = createThumbnail(animationImage, staticImages.length, true);
                galleryThumbnails.appendChild(animThumbnail);
            }
        }
        
        function createThumbnail(image, index, isAnimation) {
            const thumbnail = document.createElement('div');
            thumbnail.className = `gallery-thumbnail ${isAnimation ? 'animation' : ''}`;
            thumbnail.dataset.index = index;
            
            const img = document.createElement('img');
            img.src = image.url;
            img.alt = image.title;
            img.onerror = () => {
                thumbnail.innerHTML = '<div class="thumbnail-overlay">Error</div>';
            };
            
            const overlay = document.createElement('div');
            overlay.className = 'thumbnail-overlay';
            overlay.textContent = image.title;
            
            thumbnail.appendChild(img);
            thumbnail.appendChild(overlay);
            
            if (index === currentImageIndex && !isAnimation) {
                thumbnail.classList.add('active');
            }
            
            thumbnail.addEventListener('click', () => {
                if (isAnimation) {
                    switchViewMode('animation');
                } else {
                    selectGalleryImage(index, image);
                }
            });
            
            return thumbnail;
        }
        
        function selectGalleryImage(index, image) {
            currentImageIndex = index;
            loadGalleryMainImage(image.url, image.title);
            
            // Update thumbnail states
            document.querySelectorAll('.gallery-thumbnail:not(.animation)').forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
        }
        
        function loadGalleryMainImage(url, title) {
            console.log('Loading main image:', url, title);
            console.log('Gallery elements:', { galleryLoading, galleryError, galleryMainImg });
            
            galleryLoading.classList.remove('hidden');
            galleryError.classList.add('hidden');
            galleryMainImg.classList.add('hidden');
            
            const img = new Image();
            img.onload = () => {
                console.log('Image loaded successfully:', url);
                galleryMainImg.src = url;
                galleryMainImg.alt = title;
                galleryMainImg.classList.remove('hidden');
                galleryLoading.classList.add('hidden');
            };
            img.onerror = () => {
                console.error('Failed to load image:', url);
                galleryLoading.classList.add('hidden');
                galleryError.classList.remove('hidden');
            };
            img.src = url;
            
            // Add click handler for lightbox
            galleryMainImg.onclick = () => openLightbox(url, title);
        }
        
        function showAnimationView(project) {
            const animationImg = project.images.find(img => img.type === 'animation');
            if (animationImg) {
                viewerAnimation.classList.remove('hidden');
                animationImage.src = animationImg.url;
                animationImage.alt = animationImg.title;
                animationImage.onclick = () => openLightbox(animationImg.url, animationImg.title);
            }
        }
        
        // --- LIGHTBOX FUNCTIONALITY ---
        function openLightbox(imageSrc, title) {
            lightboxImage.src = imageSrc;
            lightboxImage.alt = title;
            lightboxInfo.textContent = title;
            lightbox.classList.add('active');
            
            // Find current image index for navigation
            if (currentProject && currentProject.images) {
                lightboxIndex = currentProject.images.findIndex(img => img.url === imageSrc);
            }
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }
        
        window.closeLightbox = function() {
            lightbox.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        window.navigateLightbox = function(direction) {
            if (!currentProject || !currentProject.images) return;
            
            lightboxIndex += direction;
            if (lightboxIndex < 0) lightboxIndex = currentProject.images.length - 1;
            if (lightboxIndex >= currentProject.images.length) lightboxIndex = 0;
            
            const image = currentProject.images[lightboxIndex];
            lightboxImage.src = image.url;
            lightboxImage.alt = image.title;
            lightboxInfo.textContent = image.title;
        }
        
        // Close lightbox on escape key or background click
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });
        
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) closeLightbox();
        });

        // --- APP LOGIC ---
        function populateProjectList() {
            projectList.innerHTML = '';
            Object.keys(yachtData).forEach(key => {
                const yacht = yachtData[key];
                const projectItem = createProjectItem(yacht, key);
                projectList.appendChild(projectItem);
            });
        }

        function createProjectItem(yacht, key) {
            const projectItem = document.createElement('div');
            projectItem.className = 'project-item animate-slide-up';
            projectItem.dataset.projectId = key;
            
            // Create thumbnail
            const thumbnail = document.createElement('div');
            thumbnail.className = 'project-thumbnail';
            
            const thumbnailImg = document.createElement('img');
            thumbnailImg.src = yacht.thumbnail;
            thumbnailImg.alt = yacht.name;
            thumbnailImg.onerror = () => {
                thumbnail.innerHTML = '<div class="w-full h-full bg-gray-700 flex items-center justify-center text-xs text-gray-400">No Image</div>';
            };
            
            thumbnail.appendChild(thumbnailImg);
            
            // Create project info
            const projectInfo = document.createElement('div');
            projectInfo.className = 'project-info';
            
            const projectName = document.createElement('div');
            projectName.className = 'project-name';
            projectName.textContent = yacht.name;
            
            const projectMeta = document.createElement('div');
            projectMeta.className = 'project-meta';
            
            const lengthSpan = document.createElement('span');
            lengthSpan.textContent = yacht.length;
            
            const badge = document.createElement('span');
            badge.className = `project-badge ${yacht.status === 'Completed' ? '' : yacht.status === 'In Progress' ? 'in-progress' : 'concept'}`;
            badge.textContent = yacht.status;
            
            projectMeta.appendChild(lengthSpan);
            projectMeta.appendChild(badge);
            
            projectInfo.appendChild(projectName);
            projectInfo.appendChild(projectMeta);
            
            // Assemble project item
            projectItem.appendChild(thumbnail);
            projectItem.appendChild(projectInfo);
            
            // Add click handler
            projectItem.addEventListener('click', () => {
                loadProject(key);
                // Handle active state
                document.querySelectorAll('.project-item').forEach(item => item.classList.remove('active'));
                projectItem.classList.add('active');
            });
            
            return projectItem;
        }

        function loadProject(projectId) {
            placeholderView.classList.add('hidden');
            projectDetailView.classList.remove('hidden');
            
            currentProject = yachtData[projectId];
            
            // Update breadcrumbs
            if (currentProjectSpan) {
                currentProjectSpan.textContent = currentProject.name;
            }
            
            // Update resource panel with project info
            updateResourcePanel(currentProject);
            
            // Close mobile sidebar if open
            closeSidebar();
            
            chatHistory.innerHTML = '';
            let lastImage = '';
            let is3DReady = false;
            let modelUrl = '';

            currentProject.history.forEach(item => {
                const bubble = document.createElement('div');
                bubble.className = 'p-3 rounded-lg max-w-md animate-fade-in';

                if (item.type === 'user') {
                    bubble.classList.add('chat-bubble-user', 'self-end');
                    bubble.textContent = item.text;
                } else if (item.type === 'ai') {
                    bubble.classList.add('chat-bubble-ai', 'self-start');
                    if (item.image) {
                        const img = document.createElement('img');
                        img.src = item.image;
                        img.alt = "AI Generated Yacht Design";
                        img.className = 'rounded-lg w-full cursor-pointer hover:scale-105 transition-transform duration-200';
                        img.onclick = () => openLightbox(item.image, "AI Generated Yacht Design");
                        bubble.appendChild(img);
                        lastImage = item.image;
                    }
                    if (item.is3D) {
                        const p = document.createElement('p');
                        p.textContent = "Here is the 3D model you requested.";
                        bubble.appendChild(p);
                        is3DReady = true;
                        modelUrl = item.modelUrl;
                    }
                }
                chatHistory.appendChild(bubble);
            });
            
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // Set up view mode event handlers
            setupViewModeHandlers();
            
            // Start with gallery view by default
            switchViewMode('gallery');
        }
        
        function setupViewModeHandlers() {
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchViewMode(btn.dataset.mode);
                });
            });
        }

        function updateDesignView(imageUrl) {
            // Legacy function - now redirects to lightbox
            openLightbox(imageUrl, "Yacht Design");
        }

        function show3DView(modelUrl) {
            // Hide all other viewers
            viewer2D.classList.add('hidden');
            viewerGallery.classList.add('hidden');
            viewerAnimation.classList.add('hidden');
            viewer3D.classList.remove('hidden');
            viewerLoader.classList.remove('hidden');
            
            // Debounce to allow loader to show
            setTimeout(() => {
                init3DViewer(modelUrl);
            }, 500);
        }

        function showPlaceholderView() {
            projectDetailView.classList.add('hidden');
            placeholderView.classList.remove('hidden');
            document.querySelectorAll('#project-list button').forEach(btn => btn.classList.remove('bg-blue-600'));
        }

        // --- 3D VIEWER LOGIC ---
        function init3DViewer(modelUrl) {
            // Clean up previous scene if it exists
            if (threeRenderer) {
                viewer3D.removeChild(threeRenderer.domElement);
            }
            if(currentModel) {
                threeScene.remove(currentModel);
            }

            // 1. Scene
            threeScene = new THREE.Scene();
            threeScene.background = new THREE.Color(0x2D3748); // Lighter background

            // 2. Camera
            threeCamera = new THREE.PerspectiveCamera(75, viewer3D.clientWidth / viewer3D.clientHeight, 0.1, 1000);
            threeCamera.position.z = 5;

            // 3. Renderer
            threeRenderer = new THREE.WebGLRenderer({ antialias: true });
            threeRenderer.setSize(viewer3D.clientWidth, viewer3D.clientHeight);
            threeRenderer.setPixelRatio(window.devicePixelRatio);
            // Enable shadows in the renderer
            threeRenderer.shadowMap.enabled = true;
            threeRenderer.shadowMap.type = THREE.PCFSoftShadowMap; // Softer shadows
            // Improve color output
            threeRenderer.outputEncoding = THREE.sRGBEncoding;
            threeRenderer.toneMapping = THREE.ACESFilmicToneMapping;
            threeRenderer.toneMappingExposure = 1.2;
            viewer3D.appendChild(threeRenderer.domElement);

            // 4. Enhanced Lighting Setup
            // Bright ambient light for overall illumination
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            threeScene.add(ambientLight);
            
            // Main directional light (sun)
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
            directionalLight.position.set(5, 10, 7.5);
            directionalLight.castShadow = true;
            // Configure shadow properties for better quality
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 50;
            directionalLight.shadow.camera.left = -10;
            directionalLight.shadow.camera.right = 10;
            directionalLight.shadow.camera.top = 10;
            directionalLight.shadow.camera.bottom = -10;
            threeScene.add(directionalLight);
            
            // Secondary fill light from opposite side
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.6);
            fillLight.position.set(-5, 5, -5);
            threeScene.add(fillLight);
            
            // Hemisphere light for natural sky/ground lighting
            const hemisphereLight = new THREE.HemisphereLight(0x87CEEB, 0x362D1D, 0.5);
            threeScene.add(hemisphereLight);
            
            // Add rim light for better edge definition
            const rimLight = new THREE.DirectionalLight(0xffffff, 0.4);
            rimLight.position.set(-10, 0, -10);
            threeScene.add(rimLight);
            
            // Add a ground plane to receive shadows
            const groundGeometry = new THREE.PlaneGeometry(20, 20);
            const groundMaterial = new THREE.ShadowMaterial({ opacity: 0.2 }); // Lighter shadow opacity
            const groundPlane = new THREE.Mesh(groundGeometry, groundMaterial);
            groundPlane.rotation.x = -Math.PI / 2;
            groundPlane.receiveShadow = true;
            threeScene.add(groundPlane);

            // 5. Controls
            threeControls = new THREE.OrbitControls(threeCamera, threeRenderer.domElement);
            threeControls.enableDamping = true;
            threeControls.dampingFactor = 0.05;
            // Lock panning, allow only rotation and zoom
            threeControls.enablePan = false;
            threeControls.minDistance = 2;
            threeControls.maxDistance = 15;
            // Ensure the controls are looking at the center
            threeControls.target.set(0, 0, 0);
            
            // 6. Extract yacht ID from model URL to load PBR textures
            const yachtId = modelUrl.match(/yacht(\d+)\.glb/)?.[1];
            const pbrBasePath = yachtId ? `resources/yacht${yachtId}/` : null;
            
            // 7. Load PBR textures asynchronously
            function loadPBRTextures() {
                return new Promise((resolve) => {
                    if (!pbrBasePath) {
                        resolve(null);
                        return;
                    }
                    
                    const textureLoader = new THREE.TextureLoader();
                    const texturePromises = [];
                    const textures = {};
                    
                    // Define texture paths and their properties
                    const textureConfigs = [
                        { name: 'diffuse', path: 'texture_pbr_v128.png', srgb: true },
                        { name: 'metallic', path: 'texture_pbr_v128_metallic.png', srgb: false },
                        { name: 'normal', path: 'texture_pbr_v128_normal.png', srgb: false },
                        { name: 'roughness', path: 'texture_pbr_v128_roughness.png', srgb: false }
                    ];
                    
                    textureConfigs.forEach(config => {
                        const promise = new Promise((textureResolve, textureReject) => {
                            textureLoader.load(
                                pbrBasePath + config.path,
                                (texture) => {
                                    // Configure texture wrapping and encoding
                                    texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                                    texture.flipY = false;
                                    
                                    if (config.srgb) {
                                        texture.encoding = THREE.sRGBEncoding;
                                    } else {
                                        texture.encoding = THREE.LinearEncoding;
                                    }
                                    
                                    textures[config.name] = texture;
                                    textureResolve();
                                },
                                undefined,
                                (error) => {
                                    console.warn(`Failed to load texture ${config.path}:`, error);
                                    textureResolve(); // Don't fail completely, just skip this texture
                                }
                            );
                        });
                        texturePromises.push(promise);
                    });
                    
                    Promise.all(texturePromises).then(() => {
                        // Only resolve with textures if we have at least the diffuse map
                        if (textures.diffuse) {
                            resolve(textures);
                        } else {
                            console.warn('No diffuse texture found, skipping PBR materials');
                            resolve(null);
                        }
                    });
                });
            }
            
            // 8. Apply PBR materials to model
            function applyPBRMaterials(model, textures) {
                if (!textures) return;
                
                model.traverse(function (node) {
                    if (node.isMesh) {
                        // Create new PBR material with proper settings
                        const materialConfig = {
                            map: textures.diffuse,
                            metalness: 0.1,
                            roughness: 0.8,
                            transparent: false,
                            side: THREE.DoubleSide
                        };
                        
                        // Add optional texture maps if available
                        if (textures.normal) {
                            materialConfig.normalMap = textures.normal;
                            materialConfig.normalScale = new THREE.Vector2(1, 1);
                        }
                        
                        if (textures.metallic) {
                            materialConfig.metalnessMap = textures.metallic;
                            materialConfig.metalness = 1.0; // Use full metalness when map is present
                        }
                        
                        if (textures.roughness) {
                            materialConfig.roughnessMap = textures.roughness;
                            materialConfig.roughness = 1.0; // Use full roughness when map is present
                        }
                        
                        const pbrMaterial = new THREE.MeshStandardMaterial(materialConfig);
                        
                        // Apply the new material
                        if (Array.isArray(node.material)) {
                            // Handle multi-material objects
                            node.material = node.material.map(() => pbrMaterial.clone());
                        } else {
                            node.material = pbrMaterial;
                        }
                        
                        node.castShadow = true;
                        node.receiveShadow = true;
                    }
                });
            }

            // 9. Model Loader
            const loader = new THREE.GLTFLoader();
            
            // Load model and textures simultaneously
            Promise.all([
                new Promise((resolve, reject) => {
                    loader.load(modelUrl, resolve, undefined, reject);
                }),
                loadPBRTextures()
            ]).then(([gltf, pbrTextures]) => {
                currentModel = gltf.scene;
                
                // Apply PBR materials if textures are available
                if (pbrTextures) {
                    console.log('Applying PBR textures to model');
                    applyPBRMaterials(currentModel, pbrTextures);
                } else {
                    console.log('Using default materials');
                    // Fallback: just enable shadows for existing materials
                    currentModel.traverse(function (node) {
                        if (node.isMesh) {
                            node.castShadow = true;
                            node.receiveShadow = true;
                            // Enhance existing materials if possible
                            if (node.material) {
                                if (node.material.isMeshBasicMaterial) {
                                    // Convert basic material to standard for better lighting
                                    const standardMaterial = new THREE.MeshStandardMaterial({
                                        color: node.material.color,
                                        map: node.material.map,
                                        transparent: node.material.transparent,
                                        opacity: node.material.opacity
                                    });
                                    node.material = standardMaterial;
                                }
                            }
                        }
                    });
                }
                
                // Center and scale model
                const box = new THREE.Box3().setFromObject(currentModel);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 3 / maxDim;
                
                currentModel.position.sub(center);
                currentModel.scale.multiplyScalar(scale);

                // Adjust ground plane to be just below the model
                const modelBox = new THREE.Box3().setFromObject(currentModel);
                groundPlane.position.y = modelBox.min.y - 0.1;

                threeScene.add(currentModel);
                viewerLoader.classList.add('hidden');
            }).catch((error) => {
                console.error('An error happened while loading the model or textures:', error);
                viewerLoader.classList.add('hidden');
                viewer3D.innerHTML = '<p class="text-red-400">Failed to load 3D model or textures.</p>';
            });

            // 10. Animation Loop
            function animate() {
                requestAnimationFrame(animate);
                threeControls.update();
                threeRenderer.render(threeScene, threeCamera);
            }
            animate();
            
            // Handle resize
            window.addEventListener('resize', onWindowResize, false);
            function onWindowResize() {
                if (!threeRenderer) return;
                threeCamera.aspect = viewer3D.clientWidth / viewer3D.clientHeight;
                threeCamera.updateProjectionMatrix();
                threeRenderer.setSize(viewer3D.clientWidth, viewer3D.clientHeight);
            }
        }
    </script>
</body>
</html>
