<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACWASIM</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button.active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        .tab-button:disabled {
            color: #9ca3af;
            cursor: not-allowed;
        }
        #network-visualizer-container {
            position: relative;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            overflow: auto;
            min-height: 500px;
        }
        
        #network-visualizer-content {
            position: relative;
            min-width: 100%;
            min-height: 100%;
            padding: 5px;
            width: max-content;
            height: max-content;
        }
        
        .component-node {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 9px;
            cursor: pointer;
            border: 2px solid #374151;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .component-node:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            z-index: 10;
        }
        
        .component-node.source { 
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-color: #1e40af;
        }
        .component-node.pump { 
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-color: #b45309;
        }
        .component-node.valve { 
            background: linear-gradient(135deg, #eab308, #ca8a04);
            border-color: #a16207;
        }
        .component-node.junction { 
            background: linear-gradient(135deg, #6b7280, #4b5563);
            border-color: #374151;
        }
        .component-node.tank { 
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #047857;
        }
        .component-node.sink { 
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: #b91c1c;
        }
        
        .pipe-line {
            position: absolute;
            height: 3px;
            background: linear-gradient(90deg, #374151, #6b7280);
            transform-origin: left center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .pipe-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 10px solid #374151;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            transform-origin: left center;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }
        
        .connectivity-matrix {
            border-collapse: collapse;
            width: 100%;
            font-size: 12px;
        }
        
        .connectivity-matrix th,
        .connectivity-matrix td {
            border: 1px solid #d1d5db;
            padding: 8px;
            text-align: center;
            min-width: 40px;
        }
        
        .connectivity-matrix th {
            background-color: #f9fafb;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .connectivity-matrix th:first-child {
            position: sticky;
            left: 0;
            background-color: #f9fafb;
            z-index: 20;
        }
        
        .connectivity-matrix td:first-child {
            position: sticky;
            left: 0;
            background-color: #f9fafb;
            font-weight: bold;
            z-index: 10;
        }
        
        .connectivity-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .connectivity-checkbox:checked {
            accent-color: #3b82f6;
        }
        
        .component-type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
        }
        
        .badge-source { background-color: #3b82f6; }
        .badge-pump { background-color: #f59e0b; }
        .badge-valve { background-color: #eab308; }
        .badge-junction { background-color: #6b7280; }
        .badge-tank { background-color: #10b981; }
        .badge-sink { background-color: #ef4444; }
        .label {
            color: #1f2937;
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            padding: 2px 5px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            border: 1px solid rgba(0,0,0,0.1);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-4 text-gray-900">ACWASIM</h1>

        <!-- System Management View -->
        <div id="system-management-view" class="bg-white rounded-lg shadow-lg p-8 text-center">
            <h2 class="text-2xl font-semibold mb-4">System Management</h2>
            <p class="text-gray-600 mb-6">Load an existing system or start a new one.</p>
            <div class="max-w-md mx-auto space-y-4">
                <div class="flex items-center space-x-2">
                    <select id="sampleSystemsList" class="block w-full rounded-md border-gray-300 shadow-sm p-3"></select>
                    <button onclick="loadSelectedSampleSystem()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg whitespace-nowrap">Load Sample</button>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="document.getElementById('loadSystemInput').click()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg w-full">Load System from File</button>
                    <input type="file" id="loadSystemInput" class="hidden" accept=".json" onchange="loadSystemFromFile(event)">
                    <button onclick="createNewSystem()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg w-full">Create New System</button>
                </div>
            </div>
        </div>
        
        <!-- Main Simulator View -->
        <div id="main-simulator-view" class="hidden">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-semibold" id="system-name-display"></h2>
                 <button onclick="showSystemManagementView()" class="text-sm text-blue-600 hover:underline">&larr; Back to System Management</button>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6">
                <!-- Tabs -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex flex-wrap space-x-8" aria-label="Tabs">
                        <button onclick="changeTab(event, 'build')" id="tab-btn-build" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Build Your Network</button>
                        <button onclick="changeTab(event, 'simulation')" id="tab-btn-simulation" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Simulation Settings</button>
                        <button onclick="changeTab(event, 'analysis')" id="tab-btn-analysis" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" disabled>Analysis & Visualization</button>
                        <button onclick="changeTab(event, 'controls')" id="tab-btn-controls" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Timed Control Actions</button>
                        <button onclick="changeTab(event, 'conditionals')" id="tab-btn-conditionals" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Conditional Actions</button>
                        <button onclick="changeTab(event, 'attacks')" id="tab-btn-attacks" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Cyber-Physical Attacks</button>
                    </nav>
                </div>

                <!-- Build Your Network Tab -->
                <div id="build" class="tab-content active mt-6">
                                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                    <div class="lg:col-span-1 space-y-3">
                            <h2 class="text-xl font-semibold">Components</h2>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="addComponent('source')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Add Source</button>
                                <button onclick="addComponent('pump')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Add Pump</button>
                                <button onclick="addComponent('valve')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Add Valve</button>
                                <button onclick="addComponent('junction')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Add Junction</button>
                                <button onclick="openTankModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Add Tank</button>
                                <button onclick="addComponent('sink')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Add Sink</button>
                            </div>
                            
                            <hr>
                            <h3 class="text-lg font-semibold">Legend</h3>
                            <div class="space-y-1 text-sm">
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 rounded-full" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); border: 2px solid #1e40af;"></div>
                                    <span>Source</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 rounded-full" style="background: linear-gradient(135deg, #f59e0b, #d97706); border: 2px solid #b45309;"></div>
                                    <span>Pump</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 rounded-full" style="background: linear-gradient(135deg, #eab308, #ca8a04); border: 2px solid #a16207;"></div>
                                    <span>Valve</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 rounded-full" style="background: linear-gradient(135deg, #6b7280, #4b5563); border: 2px solid #374151;"></div>
                                    <span>Junction</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 rounded-full" style="background: linear-gradient(135deg, #10b981, #059669); border: 2px solid #047857;"></div>
                                    <span>Tank</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 rounded-full" style="background: linear-gradient(135deg, #ef4444, #dc2626); border: 2px solid #b91c1c;"></div>
                                    <span>Sink</span>
                                </div>
                            </div>
                            <hr>
                            <h2 class="text-xl font-semibold">Network Management</h2>
                            <div class="flex space-x-2">
                                <button onclick="saveSystem()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex-1">Save System</button>
                            </div>
                             <button id="connectComponentsBtn" onclick="openConnectivityModal()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg w-full">Connectivity Matrix</button>
                             <div class="text-xs text-gray-500 mt-2">
                                 <span id="layout-info">Layout: Balanced</span>
                                 <select id="layoutSelector" class="ml-2 text-xs border border-gray-300 rounded px-1 py-0.5" onchange="changeLayout()">
                                     <option value="balanced">Balanced</option>
                                     <option value="topological">Topological</option>
                                     <option value="compact">Compact</option>
                                 </select>
                             </div>

                        </div>
                        <div id="network-visualizer-container" class="lg:col-span-3 bg-gray-200 rounded-lg p-2" style="height: 500px;">
                            <div id="network-visualizer-content">
                                <!-- Components and pipes will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Simulation Settings Tab -->
                <div id="simulation" class="tab-content mt-6">
                    <h2 class="text-xl font-semibold mb-4">Simulation Parameters</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="simDuration" class="block text-sm font-medium text-gray-700">Simulation Duration (seconds)</label>
                            <input type="number" id="simDuration" value="900" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        </div>
                         <div>
                            <label for="ambientTemp" class="block text-sm font-medium text-gray-700">Ambient Temperature (°C)</label>
                            <input type="number" id="ambientTemp" value="20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        </div>
                         <button onclick="startSimulation()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Start Simulation</button>
                         <div id="simulation-progress" class="hidden mt-4">
                            <p>Simulation in progress...</p>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold mt-6 mb-2">Initial State</h3>
                    <div id="initial-conditions-container" class="space-y-2">
                        <!-- Dynamic content here -->
                    </div>
                </div>

                <!-- Analysis & Visualization Tab -->
                <div id="analysis" class="tab-content mt-6">
                    <div id="analysis-prompt" class="text-center p-8 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-medium text-gray-700">No data to display.</h3>
                        <p class="mt-1 text-sm text-gray-500">Please run a simulation to generate data for analysis.</p>
                    </div>
                    <div id="analysis-content" class="hidden">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex-grow mr-4">
                                <label for="analysisComponent" class="block text-sm font-medium text-gray-700">Select Component for Analysis</label>
                                <select id="analysisComponent" onchange="renderAnalysisCharts()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                            </div>
                            <div class="mt-6">
                                <button id="exportResultsBtn" onclick="exportResults()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Export Results (CSV)</button>
                            </div>
                        </div>
                        <div id="charts-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Charts will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- Timed Control Actions Tab -->
                <div id="controls" class="tab-content mt-6">
                     <h2 class="text-xl font-semibold mb-4">Timed Control Actions</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="controlTime" class="block text-sm font-medium text-gray-700">Time (s)</label>
                                <input type="number" id="controlTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label for="controlComponent" class="block text-sm font-medium text-gray-700">Component</label>
                                <select id="controlComponent" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                            </div>
                            <div>
                                <label for="controlAction" class="block text-sm font-medium text-gray-700">Action</label>
                                <select id="controlAction" onchange="updateControlActionParams()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    <option value="set_pump_power">Set Pump Power</option>
                                    <option value="set_valve_state">Set Valve State</option>
                                </select>
                            </div>
                             <div id="controlActionParams">
                                <!-- Dynamic params based on action -->
                            </div>
                            <button onclick="addControlAction()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Add Action</button>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold mt-6 mb-2">Scheduled Actions</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time (s)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Component</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parameters</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="controlActionsTable" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Conditional Actions Tab -->
                <div id="conditionals" class="tab-content mt-6">
                    <h2 class="text-xl font-semibold mb-4">Conditional Actions</h2>
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Trigger Part -->
                            <div class="space-y-2">
                                <h4 class="font-medium text-gray-800">IF</h4>
                                <div class="flex items-center space-x-2">
                                    <select id="cond_source_comp" class="w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                                    <select id="cond_source_val" class="w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <select id="cond_operator" class="w-1/2 rounded-md border-gray-300 shadow-sm p-2">
                                        <option value=">">is greater than</option>
                                        <option value="<">is less than</option>
                                        <option value="==">is equal to</option>
                                    </select>
                                    <input type="number" id="cond_threshold" placeholder="Value" class="w-1/2 rounded-md border-gray-300 shadow-sm p-2">
                                </div>
                            </div>
                            <!-- Action Part -->
                            <div class="space-y-2">
                                <h4 class="font-medium text-gray-800">THEN</h4>
                                 <select id="cond_target_comp" class="w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                                 <select id="cond_target_action" onchange="updateConditionalActionParams()" class="w-full rounded-md border-gray-300 shadow-sm p-2">
                                    <option value="set_pump_power">Set Pump Power</option>
                                    <option value="set_valve_state">Set Valve State</option>
                                </select>
                                <div id="conditionalActionParams"></div>
                            </div>
                            <!-- Add Button -->
                            <div class="flex items-end">
                                 <button onclick="addConditionalAction()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg w-full">Add Conditional Action</button>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold mt-6 mb-2">Defined Rules</h3>
                     <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Condition</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                                </tr>
                            </thead>
                            <tbody id="conditionalActionsTable" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Cyber-Physical Attacks Tab -->
                <div id="attacks" class="tab-content mt-6">
                    <h2 class="text-xl font-semibold mb-4">Cyber-Physical Attack Scenarios</h2>
                     <div class="flex space-x-2 mb-4">
                        <button onclick="document.getElementById('importAttacksInput').click()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg flex-1">Import Scenarios</button>
                        <input type="file" id="importAttacksInput" class="hidden" accept=".json" onchange="importAttackScenarios(event)">
                        <button onclick="exportAttackScenarios()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg flex-1">Export Scenarios</button>
                    </div>

                    <div class="space-y-6">
                        <!-- Chemical Dosing Attack -->
                        <div class="p-4 border rounded-lg">
                            <h3 class="font-semibold mb-2">Chemical Dosing (pH Attack)</h3>
                             <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <input type="number" id="cdTime" placeholder="Time (s)" class="rounded-md p-2">
                                <select id="cdComponent" class="rounded-md p-2"></select>
                                <select id="cdChemicalType" class="rounded-md p-2">
                                    <option value="acid">Acid (e.g., H₂SO₄)</option>
                                    <option value="base">Base (e.g., NaOH)</option>
                                </select>
                                <button onclick="addAttack('chemical_dosing')" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg">Add</button>
                            </div>
                        </div>
                        <!-- Chemical Interference -->
                        <div class="p-4 border rounded-lg">
                            <h3 class="font-semibold mb-2">Chemical Interference</h3>
                             <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                                <input type="number" id="ciTime" placeholder="Time (s)" class="rounded-md p-2">
                                <select id="ciComponent" class="rounded-md p-2"></select>
                                <select id="ciChemical" class="rounded-md p-2">
                                    <option value="BODn">BODn</option>
                                    <option value="O2">O2</option>
                                    <option value="nitrate">Nitrate</option>
                                    <option value="CO2">CO2</option>
                                </select>
                                <input type="number" id="ciAmount" placeholder="Amount" class="rounded-md p-2">
                                <button onclick="addAttack('chemical_interference')" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg">Add</button>
                            </div>
                        </div>
                        <!-- Physical Damage -->
                        <div class="p-4 border rounded-lg">
                            <h3 class="font-semibold mb-2">Physical Damage</h3>
                             <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <input type="number" id="pdTime" placeholder="Time (s)" class="rounded-md p-2">
                                <select id="pdComponent" class="rounded-md p-2"></select>
                                <select id="pdType" class="rounded-md p-2">
                                    <option value="leak">Tank/Pipe Leak</option>
                                    <option value="pump_failure">Pump Failure</option>
                                    <option value="valve_stuck">Valve Stuck</option>
                                </select>
                                <button onclick="addAttack('physical_damage')" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg">Add</button>
                            </div>
                        </div>
                        <!-- Data Poisoning -->
                        <div class="p-4 border rounded-lg">
                            <h3 class="font-semibold mb-2">Data Poisoning</h3>
                            <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                                <input type="number" id="dpTime" placeholder="Start Time (s)" class="rounded-md p-2">
                                <input type="number" id="dpDuration" placeholder="Duration (s)" class="rounded-md p-2">
                                <select id="dpComponent" class="rounded-md p-2"></select>
                                <select id="dpSensor" class="rounded-md p-2">
                                    <option value="waterLevel">Water Level</option>
                                    <option value="temperature">Temperature</option>
                                    <option value="ph">pH</option>
                                    <option value="o2">O2</option>
                                    <option value="bodn">BODn</option>
                                    <option value="nitrate">Nitrate</option>
                                    <option value="co2">CO2</option>
                                </select>
                                <input type="number" id="dpValue" placeholder="Fake Value" class="rounded-md p-2">
                                <button onclick="addAttack('data_poisoning')" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg">Add</button>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold mt-6 mb-2">Scheduled Attacks</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time (s)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Component</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                                </tr>
                            </thead>
                            <tbody id="attacksTable" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="tankModal" class="modal">
        <div class="modal-content">
            <span onclick="closeTankModal()" class="close float-right text-2xl font-bold cursor-pointer">&times;</span>
            <h2 class="text-xl font-semibold mb-4">Select Tank Type</h2>
            <div class="grid grid-cols-3 gap-4">
                <button onclick="addComponent('tank', {shape: 'cylindrical'})" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Cylindrical</button>
                <button onclick="addComponent('tank', {shape: 'rectangular'})" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Rectangular</button>
                <button onclick="addComponent('tank', {shape: 'spherical'})" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Spherical</button>
            </div>
        </div>
    </div>
    <div id="connectivityModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 80vh; overflow-y: auto;">
            <span onclick="closeConnectivityModal()" class="close float-right text-2xl font-bold cursor-pointer">&times;</span>
            <h2 class="text-xl font-semibold mb-4">Connectivity Matrix</h2>
            <p class="text-sm text-gray-600 mb-4">Check the boxes to create connections between components. Rows = From, Columns = To.</p>
            
            <div class="overflow-x-auto">
                <div id="connectivityMatrix" class="min-w-full">
                    <!-- Matrix will be generated here -->
                </div>
            </div>
            
            <div class="mt-6 flex justify-between items-center">
                <button onclick="clearAllConnections()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Clear All</button>
                <button onclick="closeConnectivityModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>
    <div id="selectionModal" class="modal">
        <div class="modal-content" style="width: 300px; margin-top: 20%;">
            <span onclick="closeSelectionModal()" class="close float-right text-2xl font-bold cursor-pointer">&times;</span>
            <h2 class="text-xl font-semibold mb-4">Selected: <span id="selectedComponentId"></span></h2>
            <div class="space-y-2">
                <button onclick="openEditModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg w-full">Edit Component</button>
                <button onclick="deleteSelectedComponent()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg w-full">Delete Component</button>
            </div>
        </div>
    </div>
    <div id="editModal" class="modal">
        <div class="modal-content" style="width: 400px;">
            <span onclick="closeEditModal()" class="close float-right text-2xl font-bold cursor-pointer">&times;</span>
            <h2 class="text-xl font-semibold mb-4">Edit Component</h2>
            <input type="hidden" id="originalComponentId">
            <div class="space-y-4">
                <div>
                    <label for="editComponentId" class="block text-sm font-medium text-gray-700">Component ID</label>
                    <input type="text" id="editComponentId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div id="editComponentProperties" class="space-y-2">
                    <!-- Dynamic properties will be injected here -->
                </div>
                <button onclick="saveComponentChanges()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full">Save Changes</button>
            </div>
        </div>
    </div>
    <div id="editTimedActionModal" class="modal">
        <div class="modal-content" style="width: 500px;">
            <span onclick="closeEditTimedActionModal()" class="close float-right text-2xl font-bold cursor-pointer">&times;</span>
            <h2 class="text-xl font-semibold mb-4">Edit Timed Action</h2>
            <input type="hidden" id="editControlActionIndex">
            <div class="space-y-4">
                <div>
                    <label for="editControlTime" class="block text-sm font-medium text-gray-700">Time (s)</label>
                    <input type="number" id="editControlTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div>
                    <label for="editControlComponent" class="block text-sm font-medium text-gray-700">Component</label>
                    <select id="editControlComponent" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                </div>
                <div>
                    <label for="editControlAction" class="block text-sm font-medium text-gray-700">Action</label>
                    <select id="editControlAction" onchange="updateEditControlActionParams()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <option value="set_pump_power">Set Pump Power</option>
                        <option value="set_valve_state">Set Valve State</option>
                    </select>
                </div>
                <div id="editControlActionParams"></div>
                <button onclick="saveTimedActionChanges()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // --- Global State ---
        let systemName = "Untitled System";
        let network = {};
        let controlActions = [];
        let conditionalActions = [];
        let attackScenarios = [];
        let componentCounter = {};
        let lastSimulationResults = null;
        let activeCharts = [];

        // --- Sample Data ---
        const sampleSystems = [
            {
                name: "4-Tank Timed Loop",
                network: {
                    components: [
                        { id: 'tank_1', type: 'tank', shape: 'cylindrical', radius: 1, maxLevel: 10, waterLevel: 9, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 10, y: 0, z: 0 } },
                        { id: 'pump_1', type: 'pump', maxFlowRate: 0.5, power: 0, temperature: 15, ph: 7.2, o2: 9, bodn: 1, nitrate: 0.5, co2: 4, position: { x: 7, y: 7, z: 0 } },
                        { id: 'tank_2', type: 'tank', shape: 'cylindrical', radius: 1, maxLevel: 10, waterLevel: 0, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 10, z: 0 } },
                        { id: 'pump_2', type: 'pump', maxFlowRate: 0.5, power: 0, temperature: 15, ph: 7.2, o2: 9, bodn: 1, nitrate: 0.5, co2: 4, position: { x: -7, y: 7, z: 0 } },
                        { id: 'tank_3', type: 'tank', shape: 'cylindrical', radius: 1, maxLevel: 10, waterLevel: 9, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: -10, y: 0, z: 0 } },
                        { id: 'pump_3', type: 'pump', maxFlowRate: 0.5, power: 0, temperature: 15, ph: 7.2, o2: 9, bodn: 1, nitrate: 0.5, co2: 4, position: { x: -7, y: -7, z: 0 } },
                        { id: 'tank_4', type: 'tank', shape: 'cylindrical', radius: 1, maxLevel: 10, waterLevel: 0, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: -10, z: 0 } },
                        { id: 'pump_4', type: 'pump', maxFlowRate: 0.5, power: 0, temperature: 15, ph: 7.2, o2: 9, bodn: 1, nitrate: 0.5, co2: 4, position: { x: 7, y: -7, z: 0 } },
                    ],
                    pipes: [
                        { id: 'pipe_1', from: 'tank_1', to: 'pump_1' }, { id: 'pipe_2', from: 'pump_1', to: 'tank_2' },
                        { id: 'pipe_3', from: 'tank_2', to: 'pump_2' }, { id: 'pipe_4', from: 'pump_2', to: 'tank_3' },
                        { id: 'pipe_5', from: 'tank_3', to: 'pump_3' }, { id: 'pipe_6', from: 'pump_3', to: 'tank_4' },
                        { id: 'pipe_7', from: 'tank_4', to: 'pump_4' }, { id: 'pipe_8', from: 'pump_4', to: 'tank_1' },
                    ]
                },
                controlActions: [
                    {time: 0, componentId: "pump_1", actionType: "set_pump_power", params: {power: "100"}},
                    {time: 100, componentId: "pump_2", actionType: "set_pump_power", params: {power: "100"}},
                    {time: 100, componentId: "pump_1", actionType: "set_pump_power", params: {power: "0"}},
                    {time: 200, componentId: "pump_3", actionType: "set_pump_power", params: {power: "100"}},
                    {time: 200, componentId: "pump_2", actionType: "set_pump_power", params: {power: "0"}},
                    {time: 300, componentId: "pump_4", actionType: "set_pump_power", params: {power: "100"}},
                    {time: 300, componentId: "pump_3", actionType: "set_pump_power", params: {power: "0"}},
                    {time: 400, componentId: "pump_1", actionType: "set_pump_power", params: {power: "100"}},
                    {time: 400, componentId: "pump_4", actionType: "set_pump_power", params: {power: "0"}},
                    {time: 500, componentId: "pump_2", actionType: "set_pump_power", params: {power: "100"}},
                    {time: 500, componentId: "pump_1", actionType: "set_pump_power", params: {power: "0"}},
                    {time: 600, componentId: "pump_3", actionType: "set_pump_power", params: {power: "100"}},
                    {time: 600, componentId: "pump_2", actionType: "set_pump_power", params: {power: "0"}},
                    {time: 700, componentId: "pump_4", actionType: "set_pump_power", params: {power: "100"}},
                    {time: 700, componentId: "pump_3", actionType: "set_pump_power", params: {power: "0"}},
                    {time: 800, componentId: "pump_1", actionType: "set_pump_power", params: {power: "100"}},
                    {time: 800, componentId: "pump_4", actionType: "set_pump_power", params: {power: "0"}},
                ],
                conditionalActions: [
                    {
                        source: { componentId: "tank_3", value: "level" },
                        condition: { operator: ">", threshold: 0.8 },
                        target: { componentId: "pump_3", actionType: "emergency_stop", params: {} }
                    },
                    {
                        source: { componentId: "tank_3", value: "level" },
                        condition: { operator: "<", threshold: 0.1 },
                        target: { componentId: "pump_3", actionType: "emergency_stop", params: {} }
                    },
                    {
                        source: { componentId: "tank_3", value: "level" },
                        condition: { operator: ">", threshold: 0.5 },
                        target: { componentId: "pump_3", actionType: "set_pump_power", params: { power: "100" } }
                    }
                ],
                attackScenarios: [],
                simulationSettings: {
                    duration: 900,
                    ambientTemp: 20
                }
            },
            {
                name: "4-Tank Conditional Loop",
                network: {
                    components: [
                        { id: 'tank_1', type: 'tank', shape: 'cylindrical', radius: 1, maxLevel: 10, waterLevel: 9, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 10, y: 0, z: 0 } },
                        { id: 'pump_1', type: 'pump', maxFlowRate: 0.5, power: 0, temperature: 15, ph: 7.2, o2: 9, bodn: 1, nitrate: 0.5, co2: 4, position: { x: 7, y: 7, z: 0 } },
                        { id: 'tank_2', type: 'tank', shape: 'cylindrical', radius: 1, maxLevel: 10, waterLevel: 0, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 10, z: 0 } },
                        { id: 'pump_2', type: 'pump', maxFlowRate: 0.5, power: 0, temperature: 15, ph: 7.2, o2: 9, bodn: 1, nitrate: 0.5, co2: 4, position: { x: -7, y: 7, z: 0 } },
                        { id: 'tank_3', type: 'tank', shape: 'cylindrical', radius: 1, maxLevel: 10, waterLevel: 9, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: -10, y: 0, z: 0 } },
                        { id: 'pump_3', type: 'pump', maxFlowRate: 0.5, power: 0, temperature: 15, ph: 7.2, o2: 9, bodn: 1, nitrate: 0.5, co2: 4, position: { x: -7, y: -7, z: 0 } },
                        { id: 'tank_4', type: 'tank', shape: 'cylindrical', radius: 1, maxLevel: 10, waterLevel: 0, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: -10, z: 0 } },
                        { id: 'pump_4', type: 'pump', maxFlowRate: 0.5, power: 0, temperature: 15, ph: 7.2, o2: 9, bodn: 1, nitrate: 0.5, co2: 4, position: { x: 7, y: -7, z: 0 } },
                    ],
                    pipes: [
                        { id: 'pipe_1', from: 'tank_1', to: 'pump_1' }, { id: 'pipe_2', from: 'pump_1', to: 'tank_2' },
                        { id: 'pipe_3', from: 'tank_2', to: 'pump_2' }, { id: 'pipe_4', from: 'pump_2', to: 'tank_3' },
                        { id: 'pipe_5', from: 'tank_3', to: 'pump_3' }, { id: 'pipe_6', from: 'pump_3', to: 'tank_4' },
                        { id: 'pipe_7', from: 'tank_4', to: 'pump_4' }, { id: 'pipe_8', from: 'pump_4', to: 'tank_1' },
                    ]
                },
                controlActions: [
                    {time: 0, componentId: "pump_1", actionType: "set_pump_power", params: {power: "100"}}
                ],
                conditionalActions: [
                    {
                        source: { componentId: "tank_1", value: "level" },
                        condition: { operator: ">", threshold: 0.5 },
                        target: { componentId: "pump_1", actionType: "set_pump_power", params: { power: "100" } }
                    },
                    {
                        source: { componentId: "tank_2", value: "level" },
                        condition: { operator: ">", threshold: 0.8 },
                        target: { componentId: "pump_1", actionType: "set_pump_power", params: { power: "0" } }
                    },
                    {
                        source: { componentId: "tank_2", value: "level" },
                        condition: { operator: ">", threshold: 0.2 },
                        target: { componentId: "pump_2", actionType: "set_pump_power", params: { power: "100" } }
                    },
                    {
                        source: { componentId: "tank_3", value: "level" },
                        condition: { operator: ">", threshold: 0.8 },
                        target: { componentId: "pump_2", actionType: "set_pump_power", params: { power: "0" } }
                    },
                    {
                        source: { componentId: "tank_3", value: "level" },
                        condition: { operator: ">", threshold: 0.2 },
                        target: { componentId: "pump_3", actionType: "set_pump_power", params: { power: "100" } }
                    },
                    {
                        source: { componentId: "tank_4", value: "level" },
                        condition: { operator: ">", threshold: 0.8 },
                        target: { componentId: "pump_3", actionType: "set_pump_power", params: { power: "0" } }
                    },
                    {
                        source: { componentId: "tank_4", value: "level" },
                        condition: { operator: ">", threshold: 0.2 },
                        target: { componentId: "pump_4", actionType: "set_pump_power", params: { power: "100" } }
                    },
                    {
                        source: { componentId: "tank_1", value: "level" },
                        condition: { operator: ">", threshold: 0.8 },
                        target: { componentId: "pump_4", actionType: "set_pump_power", params: { power: "0" } }
                    },
                    {
                        source: { componentId: "tank_1", value: "level" },
                        condition: { operator: "<", threshold: 0.1 },
                        target: { componentId: "pump_1", actionType: "emergency_stop", params: {} }
                    },
                    {
                        source: { componentId: "tank_2", value: "level" },
                        condition: { operator: "<", threshold: 0.1 },
                        target: { componentId: "pump_2", actionType: "emergency_stop", params: {} }
                    },
                    {
                        source: { componentId: "tank_3", value: "level" },
                        condition: { operator: "<", threshold: 0.1 },
                        target: { componentId: "pump_3", actionType: "emergency_stop", params: {} }
                    },
                    {
                        source: { componentId: "tank_4", value: "level" },
                        condition: { operator: "<", threshold: 0.1 },
                        target: { componentId: "pump_4", actionType: "emergency_stop", params: {} }
                    }
                ],
                attackScenarios: [
                    {time: 300, type: "chemical_dosing", componentId: "tank_1", chemicalType: "acid"},
                    {time: 600, type: "chemical_interference", componentId: "tank_2", chemical: "BODn", amount: 5.0},
                    {time: 450, type: "physical_damage", componentId: "pump_3", damageType: "pump_failure"}
                ],
                simulationSettings: {
                    duration: 900,
                    ambientTemp: 20
                }
            },
            {
                name: "Line Topology (ACWA)",
                network: {
                    components: [
                        { id: 'source_1', type: 'source', flowRate: 2.0, temperature: 18, ph: 7.2, o2: 9.0, bodn: 1.0, nitrate: 0.5, co2: 4.0, position: { x: 0, y: 0, z: 0 } },
                        { id: 'valve_1', type: 'valve', flowRate: 1.8, isOpen: true, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'tank_1', type: 'tank', shape: 'rectangular', width: 2.0, height: 1.5, maxLevel: 12, waterLevel: 8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 0, z: 0 } },
                        { id: 'pump_1', type: 'pump', flowRate: 1.8, efficiency: 0.85, power: 2.5, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'junction_1', type: 'junction', flowRate: 1.6, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'tank_2', type: 'tank', shape: 'rectangular', width: 2.0, height: 1.5, maxLevel: 12, waterLevel: 8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 0, z: 0 } },
                        { id: 'junction_2', type: 'junction', flowRate: 1.4, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'tank_3', type: 'tank', shape: 'rectangular', width: 2.0, height: 1.5, maxLevel: 12, waterLevel: 8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 0, z: 0 } },
                        { id: 'junction_3', type: 'junction', flowRate: 1.2, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'tank_4', type: 'tank', shape: 'rectangular', width: 2.0, height: 1.5, maxLevel: 12, waterLevel: 8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 0, z: 0 } },
                        { id: 'tank_5', type: 'tank', shape: 'rectangular', width: 2.0, height: 1.5, maxLevel: 12, waterLevel: 8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 0, z: 0 } }
                    ],
                    pipes: [
                        { id: 'pipe_source_valve', from: 'source_1', to: 'valve_1' },
                        { id: 'pipe_valve_tank1', from: 'valve_1', to: 'tank_1' },
                        { id: 'pipe_tank1_pump', from: 'tank_1', to: 'pump_1' },
                        { id: 'pipe_pump_junction1', from: 'pump_1', to: 'junction_1' },
                        { id: 'pipe_junction1_tank2', from: 'junction_1', to: 'tank_2' },
                        { id: 'pipe_junction1_junction2', from: 'junction_1', to: 'junction_2' },
                        { id: 'pipe_junction2_tank3', from: 'junction_2', to: 'tank_3' },
                        { id: 'pipe_junction2_junction3', from: 'junction_2', to: 'junction_3' },
                        { id: 'pipe_junction3_tank4', from: 'junction_3', to: 'tank_4' },
                        { id: 'pipe_junction3_tank5', from: 'junction_3', to: 'tank_5' }
                    ]
                },
                controlActions: [
                    {time: 0, componentId: "valve_1", actionType: "set_valve_flow", params: {flowRate: "1.8"}},
                    {time: 0, componentId: "pump_1", actionType: "set_pump_power", params: {power: "2.5"}},
                    {time: 300, componentId: "pump_1", actionType: "set_pump_power", params: {power: "3.0"}},
                    {time: 600, componentId: "pump_1", actionType: "set_pump_power", params: {power: "2.0"}}
                ],
                conditionalActions: [
                    {
                        source: { componentId: "tank_1", value: "level" },
                        condition: { operator: "<", threshold: 0.1 },
                        target: { componentId: "valve_1", actionType: "emergency_close", params: {} }
                    },
                    {
                        source: { componentId: "tank_1", value: "level" },
                        condition: { operator: "<", threshold: 0.1 },
                        target: { componentId: "pump_1", actionType: "emergency_stop", params: {} }
                    },
                    {
                        source: { componentId: "tank_1", value: "level" },
                        condition: { operator: ">", threshold: 0.9 },
                        target: { componentId: "valve_1", actionType: "pressure_relief", params: {} }
                    },
                    {
                        source: { componentId: "tank_2", value: "level" },
                        condition: { operator: ">", threshold: 0.8 },
                        target: { componentId: "pump_1", actionType: "reduce_power", params: { power: "50" } }
                    },
                    {
                        source: { componentId: "tank_2", value: "level" },
                        condition: { operator: "<", threshold: 0.2 },
                        target: { componentId: "pump_1", actionType: "increase_power", params: { power: "100" } }
                    }
                ],
                attackScenarios: [
                    {time: 300, type: "chemical_dosing", componentId: "tank_3", chemicalType: "acid"},
                    {time: 600, type: "chemical_interference", componentId: "tank_2", chemical: "O2", amount: -2.0},
                    {time: 450, type: "physical_damage", componentId: "valve_1", damageType: "valve_stuck"},
                    {time: 180, type: "chemical_dosing", componentId: "tank_3", chemicalType: "acid"},
                    {time: 720, type: "physical_damage", componentId: "pump_1", damageType: "pump_failure"},
                    {time: 200, type: "data_poisoning", componentId: "tank_1", poisonType: "level", value: 0.05, duration: 300},
                    {time: 400, type: "data_poisoning", componentId: "tank_2", poisonType: "level", value: 0.95, duration: 200}
                ],
                simulationSettings: {
                    duration: 900,
                    ambientTemp: 20
                }
            },
            {
                name: "Bus Topology (ACWA)",
                network: {
                    components: [
                        { id: 'source_1', type: 'source', flowRate: 2.0, temperature: 18, ph: 7.2, o2: 9.0, bodn: 1.0, nitrate: 0.5, co2: 4.0, position: { x: 0, y: 0, z: 0 } },
                        { id: 'valve_1', type: 'valve', flowRate: 1.8, isOpen: true, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'tank_1', type: 'tank', shape: 'rectangular', width: 2.0, height: 1.5, maxLevel: 12, waterLevel: 8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 0, z: 0 } },
                        { id: 'pump_1', type: 'pump', flowRate: 1.8, efficiency: 0.85, power: 2.5, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'valve_2', type: 'valve', flowRate: 1.6, isOpen: true, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'junction_1', type: 'junction', flowRate: 1.4, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'valve_3', type: 'valve', flowRate: 1.2, isOpen: true, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'tank_2', type: 'tank', shape: 'rectangular', width: 2.0, height: 1.5, maxLevel: 12, waterLevel: 8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 0, z: 0 } },
                        { id: 'valve_4', type: 'valve', flowRate: 1.0, isOpen: true, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'junction_2', type: 'junction', flowRate: 0.8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'valve_5', type: 'valve', flowRate: 0.6, isOpen: true, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'tank_3', type: 'tank', shape: 'rectangular', width: 2.0, height: 1.5, maxLevel: 12, waterLevel: 8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 0, z: 0 } },
                        { id: 'valve_6', type: 'valve', flowRate: 0.4, isOpen: true, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'junction_3', type: 'junction', flowRate: 0.2, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'valve_7', type: 'valve', flowRate: 0.1, isOpen: true, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'tank_4', type: 'tank', shape: 'rectangular', width: 2.0, height: 1.5, maxLevel: 12, waterLevel: 8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 0, z: 0 } },
                        { id: 'tank_5', type: 'tank', shape: 'rectangular', width: 2.0, height: 1.5, maxLevel: 12, waterLevel: 8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 0, z: 0 } }
                    ],
                    pipes: [
                        { id: 'pipe_source_valve1', from: 'source_1', to: 'valve_1' },
                        { id: 'pipe_valve1_tank1', from: 'valve_1', to: 'tank_1' },
                        { id: 'pipe_tank1_pump1', from: 'tank_1', to: 'pump_1' },
                        { id: 'pipe_pump1_valve2', from: 'pump_1', to: 'valve_2' },
                        { id: 'pipe_valve2_junction1', from: 'valve_2', to: 'junction_1' },
                        { id: 'pipe_junction1_valve3', from: 'junction_1', to: 'valve_3' },
                        { id: 'pipe_valve3_tank2', from: 'valve_3', to: 'tank_2' },
                        { id: 'pipe_junction1_valve4', from: 'junction_1', to: 'valve_4' },
                        { id: 'pipe_valve4_junction2', from: 'valve_4', to: 'junction_2' },
                        { id: 'pipe_junction2_valve5', from: 'junction_2', to: 'valve_5' },
                        { id: 'pipe_valve5_tank3', from: 'valve_5', to: 'tank_3' },
                        { id: 'pipe_junction2_valve6', from: 'junction_2', to: 'valve_6' },
                        { id: 'pipe_valve6_junction3', from: 'valve_6', to: 'junction_3' },
                        { id: 'pipe_junction3_valve7', from: 'junction_3', to: 'valve_7' },
                        { id: 'pipe_valve7_tank4', from: 'valve_7', to: 'tank_4' },
                        { id: 'pipe_junction3_tank5', from: 'junction_3', to: 'tank_5' }
                    ]
                },
                controlActions: [
                    {time: 0, componentId: "valve_1", actionType: "set_valve_flow", params: {flowRate: "1.8"}},
                    {time: 0, componentId: "pump_1", actionType: "set_pump_power", params: {power: "2.5"}},
                    {time: 200, componentId: "valve_2", actionType: "set_valve_flow", params: {flowRate: "1.6"}},
                    {time: 400, componentId: "valve_3", actionType: "set_valve_flow", params: {flowRate: "1.2"}},
                    {time: 600, componentId: "valve_4", actionType: "set_valve_flow", params: {flowRate: "1.0"}}
                ],
                conditionalActions: [
                    {
                        source: { componentId: "tank_1", value: "level" },
                        condition: { operator: "<", threshold: 0.1 },
                        target: { componentId: "valve_1", actionType: "emergency_close", params: {} }
                    },
                    {
                        source: { componentId: "tank_1", value: "level" },
                        condition: { operator: "<", threshold: 0.1 },
                        target: { componentId: "pump_1", actionType: "emergency_stop", params: {} }
                    },
                    {
                        source: { componentId: "tank_1", value: "level" },
                        condition: { operator: ">", threshold: 0.9 },
                        target: { componentId: "valve_2", actionType: "pressure_relief", params: {} }
                    },
                    {
                        source: { componentId: "tank_2", value: "level" },
                        condition: { operator: "<", threshold: 0.1 },
                        target: { componentId: "valve_3", actionType: "emergency_close", params: {} }
                    },
                    {
                        source: { componentId: "tank_3", value: "level" },
                        condition: { operator: "<", threshold: 0.1 },
                        target: { componentId: "valve_5", actionType: "emergency_close", params: {} }
                    },
                    {
                        source: { componentId: "tank_4", value: "level" },
                        condition: { operator: "<", threshold: 0.1 },
                        target: { componentId: "valve_7", actionType: "emergency_close", params: {} }
                    },
                    {
                        source: { componentId: "tank_1", value: "level" },
                        condition: { operator: ">", threshold: 0.8 },
                        target: { componentId: "pump_1", actionType: "reduce_power", params: { power: "50" } }
                    },
                    {
                        source: { componentId: "tank_1", value: "level" },
                        condition: { operator: "<", threshold: 0.2 },
                        target: { componentId: "pump_1", actionType: "increase_power", params: { power: "100" } }
                    }
                ],
                attackScenarios: [
                    {time: 300, type: "chemical_dosing", componentId: "tank_2", chemicalType: "acid"},
                    {time: 600, type: "physical_damage", componentId: "valve_2", damageType: "valve_stuck"},
                    {time: 450, type: "physical_damage", componentId: "valve_3", damageType: "valve_stuck"},
                    {time: 180, type: "chemical_dosing", componentId: "tank_2", chemicalType: "acid"},
                    {time: 720, type: "physical_damage", componentId: "valve_5", damageType: "valve_stuck"},
                    {time: 540, type: "chemical_interference", componentId: "tank_4", chemical: "nitrate", amount: 3.0},
                    {time: 360, type: "physical_damage", componentId: "valve_7", damageType: "valve_stuck"},
                    {time: 250, type: "data_poisoning", componentId: "tank_1", poisonType: "level", value: 0.05, duration: 300},
                    {time: 350, type: "data_poisoning", componentId: "tank_2", poisonType: "level", value: 0.95, duration: 200}
                ],
                simulationSettings: {
                    duration: 900,
                    ambientTemp: 20
                }
            },
            {
                name: "Star Topology (ACWA)",
                network: {
                    components: [
                        // Input/Supply Chain
                        { id: 'source_1', type: 'source', maxFlowRate: 3.0, temperature: 18, ph: 7.2, o2: 9.0, bodn: 1.0, nitrate: 0.5, co2: 4.0, position: { x: -25, y: 0, z: 0 } },
                        { id: 'input_valve', type: 'valve', isOpen: true, flowCoefficient: 0.8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: -20, y: 0, z: 0 } },
                        { id: 'reservoir_tank', type: 'tank', shape: 'rectangular', width: 3.0, height: 2.0, maxLevel: 15, waterLevel: 10, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: -15, y: 0, z: 0 } },
                        { id: 'reservoir_pump', type: 'pump', maxFlowRate: 2.5, power: 85, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: -10, y: 0, z: 0 } },
                        
                        // Central hub (large rectangular tank)
                        { id: 'central_hub', type: 'tank', shape: 'rectangular', width: 4.0, height: 3.0, maxLevel: 20, waterLevel: 12, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 0, z: 0 } },
                        
                        // Distribution System - Pair 1 (Top-Left and Bottom-Left)
                        { id: 'dist_pump_1', type: 'pump', maxFlowRate: 1.8, power: 80, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 5, y: 0, z: 0 } },
                        { id: 'dist_valve_1', type: 'valve', isOpen: true, flowCoefficient: 0.8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 8, y: 0, z: 0 } },
                        { id: 'peripheral_tank_1', type: 'tank', shape: 'rectangular', width: 2.0, height: 1.5, maxLevel: 12, waterLevel: 8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 12, y: 8, z: 0 } },
                        { id: 'peripheral_tank_2', type: 'tank', shape: 'rectangular', width: 2.0, height: 1.5, maxLevel: 12, waterLevel: 8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 12, y: -8, z: 0 } },
                        
                        // Distribution System - Pair 2 (Top-Right and Bottom-Right)
                        { id: 'dist_pump_2', type: 'pump', maxFlowRate: 1.6, power: 80, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 5, y: 5, z: 0 } },
                        { id: 'dist_valve_2', type: 'valve', isOpen: true, flowCoefficient: 0.8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 8, y: 5, z: 0 } },
                        { id: 'peripheral_tank_3', type: 'tank', shape: 'rectangular', width: 2.0, height: 1.5, maxLevel: 12, waterLevel: 8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 12, y: 13, z: 0 } },
                        { id: 'peripheral_tank_4', type: 'tank', shape: 'rectangular', width: 2.0, height: 1.5, maxLevel: 12, waterLevel: 8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 12, y: -3, z: 0 } }
                    ],
                    pipes: [
                        // Input/Supply Chain
                        { id: 'pipe_source_valve', from: 'source_1', to: 'input_valve' },
                        { id: 'pipe_valve_reservoir', from: 'input_valve', to: 'reservoir_tank' },
                        { id: 'pipe_reservoir_pump', from: 'reservoir_tank', to: 'reservoir_pump' },
                        { id: 'pipe_pump_hub', from: 'reservoir_pump', to: 'central_hub' },
                        
                        // Distribution Pair 1 (Top-Left and Bottom-Left)
                        { id: 'pipe_hub_pump1', from: 'central_hub', to: 'dist_pump_1' },
                        { id: 'pipe_pump1_valve1', from: 'dist_pump_1', to: 'dist_valve_1' },
                        { id: 'pipe_valve1_tank1', from: 'dist_valve_1', to: 'peripheral_tank_1' },
                        { id: 'pipe_valve1_tank2', from: 'dist_valve_1', to: 'peripheral_tank_2' },
                        
                        // Distribution Pair 2 (Top-Right and Bottom-Right)
                        { id: 'pipe_hub_pump2', from: 'central_hub', to: 'dist_pump_2' },
                        { id: 'pipe_pump2_valve2', from: 'dist_pump_2', to: 'dist_valve_2' },
                        { id: 'pipe_valve2_tank3', from: 'dist_valve_2', to: 'peripheral_tank_3' },
                        { id: 'pipe_valve2_tank4', from: 'dist_valve_2', to: 'peripheral_tank_4' }
                    ]
                },
                controlActions: [
                    {time: 0, componentId: "input_valve", actionType: "set_valve_state", params: {state: "open"}},
                    {time: 0, componentId: "reservoir_pump", actionType: "set_pump_power", params: {power: "85"}},
                    {time: 0, componentId: "dist_pump_1", actionType: "set_pump_power", params: {power: "80"}},
                    {time: 0, componentId: "dist_pump_2", actionType: "set_pump_power", params: {power: "80"}},
                    {time: 0, componentId: "dist_valve_1", actionType: "set_valve_state", params: {state: "open"}},
                    {time: 0, componentId: "dist_valve_2", actionType: "set_valve_state", params: {state: "open"}},
                    {time: 300, componentId: "reservoir_pump", actionType: "set_pump_power", params: {power: "100"}},
                    {time: 600, componentId: "dist_pump_1", actionType: "set_pump_power", params: {power: "100"}}
                ],
                conditionalActions: [
                    // Reservoir tank level control
                    {
                        source: { componentId: "reservoir_tank", value: "level" },
                        condition: { operator: "<", threshold: 0.2 },
                        target: { componentId: "reservoir_pump", actionType: "emergency_stop", params: {} }
                    },
                    {
                        source: { componentId: "reservoir_tank", value: "level" },
                        condition: { operator: ">", threshold: 0.8 },
                        target: { componentId: "input_valve", actionType: "emergency_close", params: {} }
                    },
                    // Central hub level control
                    {
                        source: { componentId: "central_hub", value: "level" },
                        condition: { operator: ">", threshold: 0.8 },
                        target: { componentId: "dist_pump_1", actionType: "set_pump_power", params: { power: "100" } }
                    },
                    {
                        source: { componentId: "central_hub", value: "level" },
                        condition: { operator: ">", threshold: 0.8 },
                        target: { componentId: "dist_pump_2", actionType: "set_pump_power", params: { power: "100" } }
                    },
                    {
                        source: { componentId: "central_hub", value: "level" },
                        condition: { operator: "<", threshold: 0.3 },
                        target: { componentId: "dist_pump_1", actionType: "set_pump_power", params: { power: "0" } }
                    },
                    {
                        source: { componentId: "central_hub", value: "level" },
                        condition: { operator: "<", threshold: 0.3 },
                        target: { componentId: "dist_pump_2", actionType: "set_pump_power", params: { power: "0" } }
                    },
                    // Peripheral tank level control
                    {
                        source: { componentId: "peripheral_tank_1", value: "level" },
                        condition: { operator: ">", threshold: 0.9 },
                        target: { componentId: "dist_valve_1", actionType: "emergency_close", params: {} }
                    },
                    {
                        source: { componentId: "peripheral_tank_2", value: "level" },
                        condition: { operator: ">", threshold: 0.9 },
                        target: { componentId: "dist_valve_1", actionType: "emergency_close", params: {} }
                    },
                    {
                        source: { componentId: "peripheral_tank_3", value: "level" },
                        condition: { operator: ">", threshold: 0.9 },
                        target: { componentId: "dist_valve_2", actionType: "emergency_close", params: {} }
                    },
                    {
                        source: { componentId: "peripheral_tank_4", value: "level" },
                        condition: { operator: ">", threshold: 0.9 },
                        target: { componentId: "dist_valve_2", actionType: "emergency_close", params: {} }
                    }
                ],
                attackScenarios: [
                    // Data poisoning attacks on critical sensors
                    {time: 200, type: "data_poisoning", componentId: "central_hub", poisonType: "waterLevel", value: 5, duration: 150},
                    {time: 400, type: "data_poisoning", componentId: "reservoir_tank", poisonType: "waterLevel", value: 2, duration: 200},
                    {time: 300, type: "data_poisoning", componentId: "peripheral_tank_1", poisonType: "waterLevel", value: 15, duration: 180},
                    // Physical damage attacks
                    {time: 250, type: "physical_damage", componentId: "reservoir_pump", damageType: "pump_failure"},
                    {time: 500, type: "physical_damage", componentId: "dist_pump_1", damageType: "pump_failure"},
                    {time: 350, type: "physical_damage", componentId: "input_valve", damageType: "valve_stuck"},
                    // Chemical interference
                    {time: 180, type: "chemical_interference", componentId: "reservoir_tank", chemical: "O2", amount: -2.0},
                    {time: 450, type: "chemical_dosing", componentId: "central_hub", chemicalType: "acid"}
                ],
                simulationSettings: {
                    duration: 900,
                    ambientTemp: 20
                }
            },
            {
                name: "No Source Network (Test)",
                network: {
                    components: [
                        { id: 'tank_1', type: 'tank', shape: 'cylindrical', radius: 1.2, maxLevel: 12, waterLevel: 8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 0, z: 0 } },
                        { id: 'tank_2', type: 'tank', shape: 'cylindrical', radius: 1.2, maxLevel: 12, waterLevel: 6, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 0, z: 0 } },
                        { id: 'pump_1', type: 'pump', maxFlowRate: 1.5, power: 80, temperature: 15, ph: 7.2, o2: 9, bodn: 1, nitrate: 0.5, co2: 4, position: { x: 0, y: 0, z: 0 } },
                        { id: 'valve_1', type: 'valve', state: 'open', flowCoefficient: 0.8, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 0, y: 0, z: 0 } },
                        { id: 'reservoir_1', type: 'tank', shape: 'cylindrical', radius: 2.0, maxLevel: 20, waterLevel: 15, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 0, y: 0, z: 0 } }
                    ],
                    pipes: [
                        { id: 'pipe_1_2', from: 'tank_1', to: 'tank_2' },
                        { id: 'pipe_2_pump', from: 'tank_2', to: 'pump_1' },
                        { id: 'pipe_pump_valve', from: 'pump_1', to: 'valve_1' },
                        { id: 'pipe_valve_reservoir', from: 'valve_1', to: 'reservoir_1' }
                    ]
                },
                controlActions: [
                    {time: 0, componentId: "pump_1", actionType: "set_pump_power", params: {power: "80"}},
                    {time: 300, componentId: "valve_1", actionType: "set_valve_state", params: {state: "closed"}},
                    {time: 600, componentId: "valve_1", actionType: "set_valve_state", params: {state: "open"}}
                ],
                conditionalActions: [],
                attackScenarios: [],
                simulationSettings: {
                    duration: 900,
                    ambientTemp: 20
                }
            },
            {
                name: "Muleshoe Water System",
                network: {
                    components: [
                        // Well Source
                        { id: 'well_source', type: 'source', maxFlowRate: 1232.028, temperature: 15, ph: 7.2, o2: 9, bodn: 1, nitrate: 0.5, co2: 4, position: { x: -20, y: 10, z: 0 } },
                        
                        // Ground Storage Tanks
                        { id: 'ground_tank_1', type: 'tank', shape: 'cylindrical', radius: 1.5, maxLevel: 50, waterLevel: 24.1, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: -10, y: 15, z: 0 } },
                        { id: 'ground_tank_2', type: 'tank', shape: 'cylindrical', radius: 1.5, maxLevel: 50, waterLevel: 20.9, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: -10, y: 5, z: 0 } },
                        
                        // Junction between well and ground storage
                        { id: 'well_junction', type: 'junction', temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: -15, y: 10, z: 0 } },
                        
                        // Junction between ground storage tanks
                        { id: 'storage_junction', type: 'junction', temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: -5, y: 10, z: 0 } },
                        
                        // Booster Pumps
                        { id: 'north_booster', type: 'pump', maxFlowRate: 0.2, power: 0, temperature: 15, ph: 7.2, o2: 9, bodn: 1, nitrate: 0.5, co2: 4, position: { x: 0, y: 15, z: 0 } },
                        { id: 'middle_booster', type: 'pump', maxFlowRate: 0.5, power: 100, temperature: 15, ph: 7.2, o2: 9, bodn: 1, nitrate: 0.5, co2: 4, position: { x: 0, y: 10, z: 0 } },
                        { id: 'south_booster', type: 'pump', maxFlowRate: 0.3, power: 0, temperature: 15, ph: 7.2, o2: 9, bodn: 1, nitrate: 0.5, co2: 4, position: { x: 0, y: 5, z: 0 } },
                        
                        // Junction between pumps
                        { id: 'pump_junction', type: 'junction', temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 5, y: 10, z: 0 } },
                        
                        // Water Tower
                        { id: 'water_tower', type: 'tank', shape: 'cylindrical', radius: 2.0, maxLevel: 150, waterLevel: 132.1, temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, power: 0, position: { x: 15, y: 10, z: 0 } },
                        
                        // Distribution Sink
                        { id: 'distribution_sink', type: 'sink', temperature: 18, ph: 7.1, o2: 8.5, bodn: 1.2, nitrate: 0.6, co2: 4.5, position: { x: 25, y: 10, z: 0 } }
                    ],
                    pipes: [
                        // Well to storage junction
                        { id: 'pipe_well_junction', from: 'well_source', to: 'well_junction' },
                        
                        // Storage junction to ground tanks
                        { id: 'pipe_junction_tank1', from: 'well_junction', to: 'ground_tank_1' },
                        { id: 'pipe_junction_tank2', from: 'well_junction', to: 'ground_tank_2' },
                        
                        // Ground tanks to storage junction
                        { id: 'pipe_tank1_storage', from: 'ground_tank_1', to: 'storage_junction' },
                        { id: 'pipe_tank2_storage', from: 'ground_tank_2', to: 'storage_junction' },
                        
                        // Storage junction to pumps
                        { id: 'pipe_storage_north', from: 'storage_junction', to: 'north_booster' },
                        { id: 'pipe_storage_middle', from: 'storage_junction', to: 'middle_booster' },
                        { id: 'pipe_storage_south', from: 'storage_junction', to: 'south_booster' },
                        
                        // Pumps to pump junction
                        { id: 'pipe_north_pump_junction', from: 'north_booster', to: 'pump_junction' },
                        { id: 'pipe_middle_pump_junction', from: 'middle_booster', to: 'pump_junction' },
                        { id: 'pipe_south_pump_junction', from: 'south_booster', to: 'pump_junction' },
                        
                        // Pump junction to water tower
                        { id: 'pipe_pump_junction_tower', from: 'pump_junction', to: 'water_tower' },
                        
                        // Water tower to distribution
                        { id: 'pipe_tower_distribution', from: 'water_tower', to: 'distribution_sink' }
                    ]
                },
                controlActions: [
                    {time: 0, componentId: "middle_booster", actionType: "set_pump_power", params: {power: "100"}},
                    {time: 0, componentId: "north_booster", actionType: "set_pump_power", params: {power: "0"}},
                    {time: 0, componentId: "south_booster", actionType: "set_pump_power", params: {power: "0"}}
                ],
                conditionalActions: [
                    // Switch LEAD/LAG pumps based on tower level
                    {
                        source: { componentId: "water_tower", value: "level" },
                        condition: { operator: "<", threshold: 120 },
                        target: { componentId: "middle_booster", actionType: "set_pump_power", params: { power: "100" } }
                    },
                    {
                        source: { componentId: "water_tower", value: "level" },
                        condition: { operator: ">", threshold: 140 },
                        target: { componentId: "middle_booster", actionType: "set_pump_power", params: { power: "0" } }
                    },
                    // Activate backup pumps when main pump is off
                    {
                        source: { componentId: "middle_booster", value: "power" },
                        condition: { operator: "<", threshold: 50 },
                        target: { componentId: "north_booster", actionType: "set_pump_power", params: { power: "100" } }
                    },
                    // Emergency stop if ground storage is too low
                    {
                        source: { componentId: "ground_tank_1", value: "level" },
                        condition: { operator: "<", threshold: 5 },
                        target: { componentId: "middle_booster", actionType: "emergency_stop", params: {} }
                    }
                ],
                attackScenarios: [
                    // Data poisoning attacks on critical sensors
                    {time: 300, type: "data_poisoning", componentId: "water_tower", poisonType: "waterLevel", value: 110, duration: 200},
                    {time: 500, type: "data_poisoning", componentId: "ground_tank_1", poisonType: "waterLevel", value: 5, duration: 150},
                    // Physical damage attacks
                    {time: 400, type: "physical_damage", componentId: "middle_booster", damageType: "pump_failure"},
                    {time: 600, type: "physical_damage", componentId: "well_junction", damageType: "leak"},
                    // Chemical interference
                    {time: 200, type: "chemical_interference", componentId: "ground_tank_1", chemical: "O2", amount: -2.0}
                ],
                simulationSettings: {
                    duration: 900,
                    ambientTemp: 20
                }
            }
        ];


        // --- Simple HTML Visualization ---
        let isVisInitialized = false;

        function initVisualization() {
            const container = document.getElementById('network-visualizer-container');
            const content = document.getElementById('network-visualizer-content');
            if (!container || !content) return;
            
            // Clear existing content
            content.innerHTML = '';
            
            isVisInitialized = true;
        }

        function updateVisualization() {
            if (!isVisInitialized) {
                initVisualization();
            }
            
            const content = document.getElementById('network-visualizer-content');
            if (!content) return;
            
            // Clear existing content
            content.innerHTML = '';
            
            // Create component nodes
            if (network.components) {
                network.components.forEach((comp, index) => createComponentVisual(comp, index));
            }
            
            // Create pipe connections
            if (network.pipes) {
                network.pipes.forEach(pipe => createPipeVisual(pipe));
            }
            
            // Update layout information
            updateLayoutInfo();
        }
        
        // Add window resize handler for dynamic layout
        function handleWindowResize() {
            if (isVisInitialized && network.components && network.components.length > 0) {
                updateVisualization();
            }
        }

        // Topological ordering functions
        function buildGraph() {
            const graph = {};
            const inDegree = {};
            
            // Initialize graph and in-degree
            network.components.forEach(comp => {
                graph[comp.id] = [];
                inDegree[comp.id] = 0;
            });
            
            // Build adjacency list and calculate in-degrees
            network.pipes.forEach(pipe => {
                if (graph[pipe.from] && graph[pipe.to]) {
                    graph[pipe.from].push(pipe.to);
                    inDegree[pipe.to]++;
                }
            });
            
            return { graph, inDegree };
        }
        
        function topologicalSort() {
            const { graph, inDegree } = buildGraph();
            const queue = [];
            const result = [];
            const visited = new Set();
            
            // Add all nodes with in-degree 0 to queue
            Object.keys(inDegree).forEach(node => {
                if (inDegree[node] === 0) {
                    queue.push(node);
                }
            });
            
            // Process queue
            while (queue.length > 0) {
                const current = queue.shift();
                result.push(current);
                visited.add(current);
                
                // Reduce in-degree of neighbors
                graph[current].forEach(neighbor => {
                    inDegree[neighbor]--;
                    if (inDegree[neighbor] === 0 && !visited.has(neighbor)) {
                        queue.push(neighbor);
                    }
                });
            }
            
            // Handle cycles by adding remaining nodes
            Object.keys(inDegree).forEach(node => {
                if (!visited.has(node)) {
                    result.push(node);
                }
            });
            
            return result;
        }
        
        function calculateBalancedPositions() {
            const { graph, inDegree } = buildGraph();
            const positions = {};
            
            // Step 1: Identify component types and their roles
            const sources = [];
            const sinks = [];
            const intermediates = [];
            const isolated = [];
            
            network.components.forEach(comp => {
                const hasIncoming = inDegree[comp.id] > 0;
                const hasOutgoing = graph[comp.id] && graph[comp.id].length > 0;
                
                if (!hasIncoming && !hasOutgoing) {
                    isolated.push(comp.id);
                } else if (!hasIncoming) {
                    sources.push(comp.id);
                } else if (!hasOutgoing) {
                    sinks.push(comp.id);
                } else {
                    intermediates.push(comp.id);
                }
            });
            
            // Step 2: Calculate positions with generous spacing
            const margin = 80;
            const minSpacing = 120; // Fixed minimum distance
            const maxWidth = 800;
            const maxHeight = 600;
            
            // Position sources at the top
            const sourceY = margin;
            sources.forEach((compId, index) => {
                const x = margin + (index * minSpacing);
                positions[compId] = { x, y: sourceY };
            });
            
            // Position sinks at the bottom
            const sinkY = maxHeight - margin;
            sinks.forEach((compId, index) => {
                const x = margin + (index * minSpacing);
                positions[compId] = { x, y: sinkY };
            });
            
            // Position intermediates in a grid pattern
            if (intermediates.length > 0) {
                const availableWidth = maxWidth - 2 * margin;
                const availableHeight = sinkY - sourceY - 2 * margin;
                const maxPerRow = Math.floor(availableWidth / minSpacing);
                const rows = Math.ceil(intermediates.length / maxPerRow);
                const rowSpacing = Math.max(minSpacing, availableHeight / (rows + 1));
                
                intermediates.forEach((compId, index) => {
                    const row = Math.floor(index / maxPerRow);
                    const col = index % maxPerRow;
                    const x = margin + (col * minSpacing);
                    const y = sourceY + margin + ((row + 1) * rowSpacing);
                    positions[compId] = { x, y };
                });
            }
            
            // Position isolated components on the right
            isolated.forEach((compId, index) => {
                const x = maxWidth - margin - (index * minSpacing);
                const y = margin + (index * minSpacing);
                positions[compId] = { x, y };
            });
            
            return positions;
        }
        
        function calculateTopologicalPositions() {
            const topoOrder = topologicalSort();
            const positions = {};
            
            // Group components by their topological level
            const levelGroups = {};
            const visited = new Set();
            const level = {};
            
            // Initialize levels
            topoOrder.forEach(compId => {
                level[compId] = 0;
            });
            
            // Calculate level for each component using BFS
            const { graph, inDegree } = buildGraph();
            const queue = [];
            
            // Start with components that have in-degree 0 (sources or isolated components)
            topoOrder.forEach(compId => {
                if (inDegree[compId] === 0) {
                    queue.push({ id: compId, level: 0 });
                    level[compId] = 0;
                    visited.add(compId);
                }
            });
            
            // Process queue to assign levels
            while (queue.length > 0) {
                const { id: currentId, level: currentLevel } = queue.shift();
                
                // Add neighbors to queue with incremented level
                if (graph[currentId]) {
                    graph[currentId].forEach(neighborId => {
                        if (!visited.has(neighborId)) {
                            const newLevel = currentLevel + 1;
                            level[neighborId] = newLevel;
                            queue.push({ id: neighborId, level: newLevel });
                            visited.add(neighborId);
                        }
                    });
                }
            }
            
            // Handle disconnected components (not reachable from any source)
            topoOrder.forEach(compId => {
                if (!visited.has(compId)) {
                    // Find the minimum level among all components that have edges to this component
                    let minLevel = 0;
                    let hasIncoming = false;
                    
                    Object.keys(graph).forEach(fromId => {
                        if (graph[fromId] && graph[fromId].includes(compId)) {
                            hasIncoming = true;
                            const fromLevel = level[fromId] || 0;
                            minLevel = Math.max(minLevel, fromLevel + 1);
                        }
                    });
                    
                    if (!hasIncoming) {
                        // Isolated component - place at level 0
                        level[compId] = 0;
                    } else {
                        level[compId] = minLevel;
                    }
                    visited.add(compId);
                }
            });
            
            // Group components by level
            Object.keys(level).forEach(compId => {
                const compLevel = level[compId];
                if (!levelGroups[compLevel]) {
                    levelGroups[compLevel] = [];
                }
                levelGroups[compLevel].push(compId);
            });
            
            // Calculate positions for each level with proper spacing
            const margin = 50;
            const levelHeight = 120;
            const horizontalSpacing = 150;
            
            Object.keys(levelGroups).forEach(levelNum => {
                const componentsInLevel = levelGroups[levelNum];
                const y = margin + parseInt(levelNum) * levelHeight;
                
                componentsInLevel.forEach((compId, index) => {
                    const x = margin + index * horizontalSpacing;
                    positions[compId] = { x, y };
                });
            });
            
            return positions;
        }
        
        function calculateCompactPositions() {
            const positions = {};
            const margin = 50;
            const minSpacing = 120; // Fixed spacing like in balanced layout
            const maxPerRow = Math.floor((800 - 2 * margin) / minSpacing);
            
            network.components.forEach((comp, index) => {
                const row = Math.floor(index / maxPerRow);
                const col = index % maxPerRow;
                const x = margin + col * minSpacing;
                const y = margin + row * minSpacing;
                positions[comp.id] = { x, y };
            });
            
            return positions;
        }
        
        // Force-directed layout handles spacing automatically
        // No need for separate collision detection functions
        
        function optimizePositions(positions, graph) {
            // Simple optimization to reduce edge crossings
            // This is a basic implementation - could be enhanced with more sophisticated algorithms
            
            const components = Object.keys(positions);
            const iterations = 3;
            
            for (let iter = 0; iter < iterations; iter++) {
                components.forEach(compId => {
                    const neighbors = graph[compId] || [];
                    const incoming = Object.keys(graph).filter(fromId => 
                        graph[fromId] && graph[fromId].includes(compId)
                    );
                    
                    // Calculate average position of neighbors
                    const allNeighbors = [...neighbors, ...incoming];
                    if (allNeighbors.length > 0) {
                        let avgX = 0, avgY = 0;
                        allNeighbors.forEach(neighborId => {
                            if (positions[neighborId]) {
                                avgX += positions[neighborId].x;
                                avgY += positions[neighborId].y;
                            }
                        });
                        avgX /= allNeighbors.length;
                        avgY /= allNeighbors.length;
                        
                        // Move component slightly towards average neighbor position
                        const currentPos = positions[compId];
                        currentPos.x = currentPos.x * 0.8 + avgX * 0.2;
                        currentPos.y = currentPos.y * 0.8 + avgY * 0.2;
                        
                        // Ensure we don't create new collisions
                        constrainToBounds(currentPos);
                    }
                });
            }
        }
        
        let currentLayout = 'balanced';
        
        function changeLayout() {
            const selector = document.getElementById('layoutSelector');
            currentLayout = selector.value;
            updateVisualization();
        }
        
        function createComponentVisual(component, index) {
            const content = document.getElementById('network-visualizer-content');
            if (!content) return;
            
            // Get positions based on current layout
            let positions;
            switch (currentLayout) {
                case 'topological':
                    positions = calculateTopologicalPositions();
                    break;
                case 'compact':
                    positions = calculateCompactPositions();
                    break;
                case 'balanced':
                default:
                    positions = calculateBalancedPositions();
                    break;
            }
            
            const position = positions[component.id] || { x: 100, y: 100 };
            
            // Store position for pipe calculations
            component.position = position;
            
            const node = document.createElement('div');
            node.className = `component-node ${component.type}`;
            node.textContent = component.id;
            node.style.left = `${position.x - 25}px`;
            node.style.top = `${position.y - 25}px`;
            node.onclick = () => openSelectionModal(component.id);
            
            content.appendChild(node);
        }
        
        function updateLayoutInfo() {
            const layoutInfo = document.getElementById('layout-info');
            if (layoutInfo && network.components) {
                const totalComponents = network.components.length;
                const { graph, inDegree } = buildGraph();
                
                // Count component types
                const sources = network.components.filter(comp => inDegree[comp.id] === 0 && (graph[comp.id] && graph[comp.id].length > 0)).length;
                const sinks = network.components.filter(comp => (graph[comp.id] && graph[comp.id].length === 0) && inDegree[comp.id] > 0).length;
                const intermediates = network.components.filter(comp => inDegree[comp.id] > 0 && (graph[comp.id] && graph[comp.id].length > 0)).length;
                const isolated = network.components.filter(comp => inDegree[comp.id] === 0 && (!graph[comp.id] || graph[comp.id].length === 0)).length;
                
                layoutInfo.textContent = `Layout: Balanced (${totalComponents} components) - Sources: ${sources}, Sinks: ${sinks}, Intermediates: ${intermediates}, Isolated: ${isolated}`;
            }
        }

        function createPipeVisual(pipe) {
            const content = document.getElementById('network-visualizer-content');
            if (!content) return;
            
            const fromComp = network.components.find(c => c.id === pipe.from);
            const toComp = network.components.find(c => c.id === pipe.to);
            
            if (!fromComp || !toComp || !fromComp.position || !toComp.position) return;
            
            const fromX = fromComp.position.x;
            const fromY = fromComp.position.y;
            const toX = toComp.position.x;
            const toY = toComp.position.y;
            
            // Calculate line properties
            const dx = toX - fromX;
            const dy = toY - fromY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            // Component radius (25px from center to edge)
            const componentRadius = 25;
            
            // Calculate intersection points with component borders
            const normalizedDx = dx / distance;
            const normalizedDy = dy / distance;
            
            // Start point (from component border)
            const startX = fromX + normalizedDx * componentRadius;
            const startY = fromY + normalizedDy * componentRadius;
            
            // End point (to component border)
            const endX = toX - normalizedDx * componentRadius;
            const endY = toY - normalizedDy * componentRadius;
            
            // Calculate new line properties
            const newDx = endX - startX;
            const newDy = endY - startY;
            const newDistance = Math.sqrt(newDx * newDx + newDy * newDy);
            const newAngle = Math.atan2(newDy, newDx) * 180 / Math.PI;
            
            // Create line
            const line = document.createElement('div');
            line.className = 'pipe-line';
            line.style.left = `${startX}px`;
            line.style.top = `${startY - 1}px`;
            line.style.width = `${newDistance}px`;
            line.style.transform = `rotate(${newAngle}deg)`;
            
            content.appendChild(line);
            
            // Create arrow at the end point
            const arrow = document.createElement('div');
            arrow.className = 'pipe-arrow';
            
            // The arrow is created using CSS borders pointing right
            // We need to position it so the tip touches the component border
            const arrowWidth = 10; // Width of the arrow (border-left width)
            const arrowHeight = 10; // Height of the arrow (border-top + border-bottom)
            
            // Calculate the position for the arrow base (left edge) so the tip touches the component border
            // The arrow points in the direction of the line, so we need to position it accordingly
            
            // Calculate the position of the arrow base (left edge) so the tip touches the border
            // We need to move back from the border point in the direction of the line
            const angleRad = newAngle * Math.PI / 180;
            const arrowBaseX = endX - arrowWidth * Math.cos(angleRad);
            const arrowBaseY = endY - arrowWidth * Math.sin(angleRad);
            
            arrow.style.left = `${arrowBaseX}px`;
            arrow.style.top = `${arrowBaseY - arrowHeight/2}px`;
            arrow.style.transform = `rotate(${newAngle}deg)`;
            
            content.appendChild(arrow);
            
            // Debug: Log arrow positioning
            console.log(`Arrow for ${pipe.from} -> ${pipe.to}:`, {
                endX, endY, newAngle,
                arrowLeft: arrow.style.left,
                arrowTop: arrow.style.top,
                arrowTransform: arrow.style.transform,
                arrowTipPosition: `${endX}px`, // This is where the tip touches
                arrowBasePosition: `${arrowBaseX}px, ${arrowBaseY}px` // This is where the base is positioned
            });
        }

        // --- UI and App Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            populateSampleSystemsList();
            updateControlActionParams();
            updateConditionalActionParams();
            
            // Initialize with the first sample system by default
            if (sampleSystems.length > 0) {
                loadSystem(JSON.parse(JSON.stringify(sampleSystems[0])));
            }
            
            // Add window resize listener for dynamic layout
            window.addEventListener('resize', handleWindowResize);
        });
        
        function populateSampleSystemsList() {
            const select = document.getElementById('sampleSystemsList');
            select.innerHTML = '';
            sampleSystems.forEach((sys, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = sys.name;
                select.appendChild(option);
            });
        }

        function loadSelectedSampleSystem() {
            const selectedIndex = document.getElementById('sampleSystemsList').value;
            if (selectedIndex >= 0 && selectedIndex < sampleSystems.length) {
                loadSystem(JSON.parse(JSON.stringify(sampleSystems[selectedIndex])));
            }
        }

        function createNewSystem() {
            const newSystem = {
                name: "New Untitled System",
                network: { components: [], pipes: [] },
                controlActions: [],
                conditionalActions: [],
                attackScenarios: [],
                simulationSettings: { duration: 600, ambientTemp: 20 }
            };
            loadSystem(newSystem);
        }

        function loadSystem(systemData) {
            systemName = systemData.name || "Untitled System";
            console.log('Loading system:', systemName); // Debug log
            network = systemData.network || { components: [], pipes: [] };
            controlActions = systemData.controlActions || [];
            conditionalActions = systemData.conditionalActions || [];
            attackScenarios = systemData.attackScenarios || [];
            
            const simSettings = systemData.simulationSettings || { duration: 600, ambientTemp: 20 };
            document.getElementById('simDuration').value = simSettings.duration;
            document.getElementById('ambientTemp').value = simSettings.ambientTemp;
            
            componentCounter = {};
            network.components.forEach(c => {
                const [type, numStr] = c.id.split('_');
                const num = parseInt(numStr);
                if (!isNaN(num)) {
                    if(!componentCounter[type] || num >= componentCounter[type]) componentCounter[type] = num + 1;
                }
            });
            
            // Calculate initial water amount from level for tanks
            network.components.filter(c => c.type === 'tank').forEach(tank => {
                let area;
                if (tank.shape === 'rectangular') {
                    area = tank.width * tank.height;
                } else {
                    // Default to cylindrical
                    area = Math.PI * tank.radius * tank.radius;
                }
                tank.waterAmount = tank.waterLevel * area;
            });

            showMainSimulatorView(); // Show the view first
            
            // Initialize visualization after DOM is ready
            setTimeout(() => {
                initVisualization();
                updateVisualization();
            }, 100);

            updateAllDropdowns();
            updateInitialConditions();
            updatePipeList();
            updateControlActionsTable();
            updateConditionalActionsTable();
            updateAttacksTable();
            resetAnalysisTab();
            
            document.getElementById('system-name-display').textContent = systemName;
            console.log('Updated system name display to:', systemName); // Debug log
        }

        function showMainSimulatorView() {
            document.getElementById('system-management-view').style.display = 'none';
            document.getElementById('main-simulator-view').style.display = 'block';
        }

        function showSystemManagementView() {
            document.getElementById('system-management-view').style.display = 'block';
            document.getElementById('main-simulator-view').style.display = 'none';
        }

        function changeTab(event, tabName) {
            document.querySelectorAll(".tab-content").forEach(el => el.style.display = "none");
            document.querySelectorAll(".tab-button").forEach(el => el.classList.remove("active"));
            document.getElementById(tabName).style.display = "block";
            event.currentTarget.classList.add("active");
            
            // If switching to build tab, update visualization
            if (tabName === 'build') {
                setTimeout(() => {
                    updateVisualization();
                }, 50);
            }
        }

        function addComponent(type, options = {}) {
            if (!componentCounter[type]) componentCounter[type] = 1;
            const id = `${type}_${componentCounter[type]++}`;
            const component = { id, type, ...options, waterLevel: 0, waterAmount: 0, temperature: 20, ph: 7, o2: 8, bodn: 2, nitrate: 1, co2: 5 };
            
            // Add default physical properties
            if (type === 'tank') {
                component.maxLevel = 10;
                component.radius = 1;
            }
            if (type === 'pump') {
                component.maxFlowRate = 0.5;
            }

            network.components.push(component);
            updateVisualization();
            updateAllDropdowns();
            updateInitialConditions();
            closeTankModal();
            resetAnalysisTab();
        }
        
        function openTankModal() { document.getElementById('tankModal').style.display = 'block'; }
        function closeTankModal() { document.getElementById('tankModal').style.display = 'none'; }
        function openConnectivityModal() {
            generateConnectivityMatrix();
            document.getElementById('connectivityModal').style.display = 'block';
        }
        
        function closeConnectivityModal() { 
            document.getElementById('connectivityModal').style.display = 'none'; 
        }

        function generateConnectivityMatrix() {
            const matrixContainer = document.getElementById('connectivityMatrix');
            if (!network.components || network.components.length === 0) {
                matrixContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No components available. Add some components first.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'connectivity-matrix';
            
            // Create header row
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>From/To</th>';
            network.components.forEach(comp => {
                const th = document.createElement('th');
                th.innerHTML = `${comp.id}<br><span class="component-type-badge badge-${comp.type}">${comp.type}</span>`;
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);
            
            // Create data rows
            network.components.forEach(fromComp => {
                const row = document.createElement('tr');
                
                // First cell (row header)
                const rowHeader = document.createElement('td');
                rowHeader.innerHTML = `${fromComp.id}<br><span class="component-type-badge badge-${fromComp.type}">${fromComp.type}</span>`;
                row.appendChild(rowHeader);
                
                // Data cells
                network.components.forEach(toComp => {
                    const cell = document.createElement('td');
                    
                    // Don't allow self-connections
                    if (fromComp.id === toComp.id) {
                        cell.innerHTML = '<span class="text-gray-400">-</span>';
                    } else {
                        // Check if this connection already exists
                        const existingConnection = network.pipes.find(pipe => 
                            pipe.from === fromComp.id && pipe.to === toComp.id
                        );
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'connectivity-checkbox';
                        checkbox.checked = !!existingConnection;
                        checkbox.onchange = () => handleConnectionChange(fromComp.id, toComp.id, checkbox.checked);
                        
                        cell.appendChild(checkbox);
                    }
                    
                    row.appendChild(cell);
                });
                
                table.appendChild(row);
            });
            
            matrixContainer.innerHTML = '';
            matrixContainer.appendChild(table);
        }

        function handleConnectionChange(fromId, toId, isConnected) {
            if (isConnected) {
                // Add connection
                const pipeId = `pipe_${network.pipes.length + 1}`;
                network.pipes.push({ id: pipeId, from: fromId, to: toId });
            } else {
                // Remove connection
                const index = network.pipes.findIndex(pipe => pipe.from === fromId && pipe.to === toId);
                if (index !== -1) {
                    network.pipes.splice(index, 1);
                }
            }
            
            updateVisualization();
            resetAnalysisTab();
        }

        function clearAllConnections() {
            network.pipes = [];
            updateVisualization();
            resetAnalysisTab();
            generateConnectivityMatrix(); // Refresh the matrix
        }
        
        function deleteSelectedComponent() {
            const componentId = document.getElementById('selectedComponentId').textContent;
            if (!componentId) return;

            // Remove component
            network.components = network.components.filter(c => c.id !== componentId);

            // Remove connected pipes
            network.pipes = network.pipes.filter(p => p.from !== componentId && p.to !== componentId);

            // Update everything
            updateVisualization();
            updateAllDropdowns();
            updateInitialConditions();
            updatePipeList();
            resetAnalysisTab();
            closeSelectionModal();
        }

        function updatePipeList() {
            // Update pipe-related UI elements if they exist
            // This function exists to prevent errors when called from other functions
            console.log('Pipe list updated - pipes:', network.pipes.length);
        }

        function updateAllDropdowns() {
            const selects = [
                document.getElementById('controlComponent'), 
                document.getElementById('ciComponent'), document.getElementById('cdComponent'),
                document.getElementById('pdComponent'), document.getElementById('dpComponent'),
                document.getElementById('analysisComponent'),
                document.getElementById('cond_source_comp'), document.getElementById('cond_target_comp'),
                document.getElementById('editControlComponent')
            ];
            const valueSelects = [document.getElementById('cond_source_val')];

            selects.forEach(select => {
                if(select) {
                    const currentVal = select.value;
                    select.innerHTML = '';
                    network.components.forEach(comp => {
                        const option = document.createElement('option');
                        option.value = comp.id;
                        option.textContent = comp.id;
                        select.appendChild(option);
                    });
                    select.value = currentVal;
                }
            });
            
            valueSelects.forEach(select => {
                if(select) {
                    const currentVal = select.value;
                    select.innerHTML = '';
                    ['waterLevel', 'waterAmount', 'temperature', 'ph', 'o2', 'bodn', 'nitrate', 'co2', 'power'].forEach(val => {
                        const option = document.createElement('option');
                        option.value = val;
                        option.textContent = val;
                        select.appendChild(option);
                    });
                    select.value = currentVal;
                }
            });
        }

        function updateInitialConditions() {
            const container = document.getElementById('initial-conditions-container');
            container.innerHTML = '';
            const units = {
                waterLevel: '(m)',
                temperature: '(°C)',
                ph: '(pH)',
                o2: '(mg/L)',
                bodn: '(mg/L)',
                nitrate: '(mg/L)',
                co2: '(mg/L)'
            };
            network.components.forEach(comp => {
                const div = document.createElement('div');
                div.className = 'p-3 border rounded-lg';
                let inputsHTML = ['waterLevel', 'temperature', 'ph', 'o2', 'bodn', 'nitrate', 'co2'].map(p => {
                    if (comp.hasOwnProperty(p)) {
                        return `<div>
                                    <label class="block text-xs font-medium text-gray-500 capitalize">${p} ${units[p] || ''}</label>
                                    <input type="number" data-id="${comp.id}" data-param="${p}" value="${comp[p]}" class="w-full rounded-md p-1 border-gray-300 shadow-sm sm:text-sm">
                                </div>`;
                    }
                    return '';
                }).join('');

                div.innerHTML = `<h4 class="font-medium">${comp.id} (${comp.type})</h4>
                                 <div class="grid grid-cols-3 md:grid-cols-7 gap-x-4 gap-y-2 mt-2">
                                     ${inputsHTML}
                                 </div>`;
                container.appendChild(div);
            });
        }

        function updateControlActionParams() {
            const action = document.getElementById('controlAction').value;
            const paramsDiv = document.getElementById('controlActionParams');
            if (action === 'set_pump_power') {
                paramsDiv.innerHTML = `<label for="pumpPower" class="block text-sm font-medium text-gray-700">Power (%)</label>
                                       <input type="number" id="pumpPower" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="0" max="100" value="100">`;
            } else if (action === 'set_valve_state') {
                paramsDiv.innerHTML = `<label for="valveState" class="block text-sm font-medium text-gray-700">State</label>
                                       <select id="valveState" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"><option value="open">Open</option><option value="closed">Closed</option></select>`;
            }
        }
        
        function updateConditionalActionParams() {
            const action = document.getElementById('cond_target_action').value;
            const paramsDiv = document.getElementById('conditionalActionParams');
            if (action === 'set_pump_power') {
                paramsDiv.innerHTML = `<input type="number" id="cond_pumpPower" class="w-full rounded-md border-gray-300 shadow-sm p-2" min="0" max="100" value="0" placeholder="Power (%)">`;
            } else if (action === 'set_valve_state') {
                paramsDiv.innerHTML = `<select id="cond_valveState" class="w-full rounded-md border-gray-300 shadow-sm p-2"><option value="open">Open</option><option value="closed">Closed</option></select>`;
            }
        }

        function addControlAction() {
            const time = document.getElementById('controlTime').value;
            const componentId = document.getElementById('controlComponent').value;
            const actionType = document.getElementById('controlAction').value;
            let params = {};
            if (actionType === 'set_pump_power') params.power = document.getElementById('pumpPower').value;
            else if (actionType === 'set_valve_state') params.state = document.getElementById('valveState').value;
            if(time && componentId) {
                controlActions.push({ time: parseInt(time), componentId, actionType, params });
                controlActions.sort((a, b) => a.time - b.time);
                updateControlActionsTable();
            }
        }

        function updateControlActionsTable() {
            const tableBody = document.getElementById('controlActionsTable');
            tableBody.innerHTML = '';
            controlActions.forEach((action, index) => {
                const row = tableBody.insertRow();
                row.innerHTML = `<td class="px-6 py-4">${action.time}</td><td class="px-6 py-4">${action.componentId}</td>
                                 <td class="px-6 py-4">${action.actionType}</td><td class="px-6 py-4">${JSON.stringify(action.params)}</td>
                                 <td class="px-6 py-4 whitespace-nowrap space-x-2">
                                    <button onclick="openEditTimedActionModal(${index})" class="text-blue-500 hover:text-blue-700">Edit</button>
                                    <button onclick="deleteTimedAction(${index})" class="text-red-500 hover:text-red-700">Delete</button>
                                 </td>`;
            });
        }
        function deleteTimedAction(index) { 
            controlActions.splice(index, 1); 
            updateControlActionsTable(); 
        }
        
        function addConditionalAction() {
            const rule = {
                source: {
                    componentId: document.getElementById('cond_source_comp').value,
                    value: document.getElementById('cond_source_val').value,
                },
                condition: {
                    operator: document.getElementById('cond_operator').value,
                    threshold: parseFloat(document.getElementById('cond_threshold').value)
                },
                target: {
                    componentId: document.getElementById('cond_target_comp').value,
                    actionType: document.getElementById('cond_target_action').value,
                    params: {}
                }
            };
            
            if (rule.target.actionType === 'set_pump_power') {
                rule.target.params.power = document.getElementById('cond_pumpPower').value;
            } else if (rule.target.actionType === 'set_valve_state') {
                rule.target.params.state = document.getElementById('cond_valveState').value;
            }
            
            if (rule.source.componentId && rule.target.componentId) {
                conditionalActions.push(rule);
                updateConditionalActionsTable();
            }
        }
        
        function updateConditionalActionsTable() {
            const tableBody = document.getElementById('conditionalActionsTable');
            tableBody.innerHTML = '';
            conditionalActions.forEach((rule, index) => {
                const conditionText = `IF ${rule.source.componentId}'s ${rule.source.value} ${rule.condition.operator} ${rule.condition.threshold}`;
                const actionText = `THEN ${rule.target.componentId} performs ${rule.target.actionType} with ${JSON.stringify(rule.target.params)}`;
                const row = tableBody.insertRow();
                row.innerHTML = `<td class="px-6 py-4">${conditionText}</td>
                                 <td class="px-6 py-4">${actionText}</td>
                                 <td class="px-6 py-4"><button onclick="removeConditionalAction(${index})" class="text-red-500">Remove</button></td>`;
            });
        }
        function removeConditionalAction(index) { conditionalActions.splice(index, 1); updateConditionalActionsTable(); }


        function addAttack(type) {
            let attack = { type };
            if (type === 'chemical_dosing') {
                attack.time = parseInt(document.getElementById('cdTime').value);
                attack.componentId = document.getElementById('cdComponent').value;
                attack.chemicalType = document.getElementById('cdChemicalType').value;
                
                // Validate chemical dosing attack
                if (!attack.time || !attack.componentId || !attack.chemicalType) {
                    alert('Please fill in all fields for the chemical dosing attack: Time, Component, and Chemical Type.');
                    return;
                }
            } else if (type === 'chemical_interference') {
                attack.time = parseInt(document.getElementById('ciTime').value);
                attack.componentId = document.getElementById('ciComponent').value;
                attack.chemical = document.getElementById('ciChemical').value;
                attack.amount = parseFloat(document.getElementById('ciAmount').value);
                
                // Validate chemical interference attack
                if (!attack.time || !attack.componentId || !attack.chemical || isNaN(attack.amount)) {
                    alert('Please fill in all fields for the chemical interference attack: Time, Component, Chemical, and Amount.');
                    return;
                }
            } else if (type === 'physical_damage') {
                attack.time = parseInt(document.getElementById('pdTime').value);
                attack.componentId = document.getElementById('pdComponent').value;
                attack.damageType = document.getElementById('pdType').value;
                
                // Validate physical damage attack
                if (!attack.time || !attack.componentId || !attack.damageType) {
                    alert('Please fill in all fields for the physical damage attack: Time, Component, and Damage Type.');
                    return;
                }
            } else if (type === 'data_poisoning') {
                attack.time = parseInt(document.getElementById('dpTime').value);
                attack.duration = parseInt(document.getElementById('dpDuration').value);
                attack.componentId = document.getElementById('dpComponent').value;
                attack.poisonType = document.getElementById('dpSensor').value;
                attack.value = parseFloat(document.getElementById('dpValue').value);
                
                // Validate data poisoning attack
                if (!attack.time || !attack.duration || !attack.componentId || !attack.poisonType || isNaN(attack.value)) {
                    alert('Please fill in all fields for the data poisoning attack: Start Time, Duration, Component, Sensor Type, and Value.');
                    return;
                }
            }
            if(attack.time !== undefined || attack.startTime !== undefined) {
                attackScenarios.push(attack);
                attackScenarios.sort((a, b) => (a.time || a.startTime) - (b.time || b.startTime));
                updateAttacksTable();
                
                // Clear the form fields after successful addition
                if (type === 'data_poisoning') {
                    document.getElementById('dpTime').value = '';
                    document.getElementById('dpDuration').value = '';
                    document.getElementById('dpComponent').value = '';
                    document.getElementById('dpSensor').value = 'waterLevel';
                    document.getElementById('dpValue').value = '';
                }
            }
        }

        function updateAttacksTable() {
            const tableBody = document.getElementById('attacksTable');
            tableBody.innerHTML = '';
            attackScenarios.forEach((attack, index) => {
                const row = tableBody.insertRow();
                let details = '';
                let timeDisplay = '';
                
                switch(attack.type) {
                    case 'chemical_dosing': 
                        details = `Type: ${attack.chemicalType}`; 
                        timeDisplay = `${attack.time || attack.startTime}`;
                        break;
                    case 'chemical_interference': 
                        details = `Chemical: ${attack.chemical}, Amount: ${attack.amount}`; 
                        timeDisplay = `${attack.time || attack.startTime}`;
                        break;
                    case 'physical_damage': 
                        details = `Damage: ${attack.damageType}`; 
                        timeDisplay = `${attack.time || attack.startTime}`;
                        break;
                    case 'data_poisoning': 
                        details = `Poison: ${attack.poisonType}, Value: ${attack.value}, Duration: ${attack.duration}s`; 
                        const startTime = attack.time || attack.startTime;
                        const endTime = startTime + attack.duration;
                        timeDisplay = `[${startTime}, ${endTime}]`;
                        break;
                }
                row.innerHTML = `<td class="px-6 py-4">${timeDisplay}</td><td class="px-6 py-4">${attack.type}</td>
                                 <td class="px-6 py-4">${attack.componentId}</td><td class="px-6 py-4">${details}</td>
                                 <td class="px-6 py-4"><button onclick="removeAttack(${index})" class="text-red-500">Remove</button></td>`;
            });
        }
        function removeAttack(index) { attackScenarios.splice(index, 1); updateAttacksTable(); }

        // --- Import/Export ---
        function saveSystem() {
            const systemNameInput = prompt("Enter a name for this system:", systemName);
            if (!systemNameInput) return; // User cancelled
            
            systemName = systemNameInput;
            document.getElementById('system-name-display').textContent = systemName;
            console.log('Updated system name display to:', systemName); // Debug log

            const systemData = {
                name: systemName,
                network: network,
                controlActions: controlActions,
                conditionalActions: conditionalActions,
                attackScenarios: attackScenarios,
                simulationSettings: {
                    duration: document.getElementById('simDuration').value,
                    ambientTemp: document.getElementById('ambientTemp').value
                }
            };
            
            const blob = new Blob([JSON.stringify(systemData, null, 2)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${systemName.replace(/\s+/g, '_')}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        }
        
        function loadSystemFromFile(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const systemData = JSON.parse(e.target.result);
                        loadSystem(systemData);
                    } catch (error) { console.error("Error parsing system file:", error); alert('Error parsing system file.'); }
                };
                reader.readAsText(file);
            }
        }
        
        function exportAttackScenarios() {
            const data = { controlActions, conditionalActions, attackScenarios };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'scenarios.json';
            a.click();
            URL.revokeObjectURL(a.href);
        }
        function importAttackScenarios(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        controlActions = data.controlActions || [];
                        conditionalActions = data.conditionalActions || [];
                        attackScenarios = data.attackScenarios || [];
                        updateControlActionsTable();
                        updateConditionalActionsTable();
                        updateAttacksTable();
                    } catch (error) { console.error("Error parsing scenarios file:", error); alert('Error parsing scenarios file.'); }
                };
                reader.readAsText(file);
            }
        }
        
        function resetAnalysisTab() {
            document.getElementById('exportResultsBtn').disabled = true;
            document.getElementById('tab-btn-analysis').disabled = true;
            document.getElementById('analysis-prompt').style.display = 'block';
            document.getElementById('analysis-content').style.display = 'none';
            lastSimulationResults = null;
        }

        // --- Analysis & Visualization ---


        function openSelectionModal(componentId) {
            document.getElementById('selectedComponentId').textContent = componentId;
            document.getElementById('selectionModal').style.display = 'block';
        }

        function closeSelectionModal() {
            document.getElementById('selectionModal').style.display = 'none';
        }

        function openEditModal() {
            const componentId = document.getElementById('selectedComponentId').textContent;
            const component = network.components.find(c => c.id === componentId);
            if (!component) return;

            document.getElementById('originalComponentId').value = componentId;
            document.getElementById('editComponentId').value = componentId;

            const propsContainer = document.getElementById('editComponentProperties');
            propsContainer.innerHTML = ''; // Clear previous properties

            if (component.type === 'tank') {
                propsContainer.innerHTML = `
                    <div>
                        <label for="edit_maxLevel" class="block text-sm font-medium text-gray-700">Max Level (Height)</label>
                        <input type="number" id="edit_maxLevel" value="${component.maxLevel || 10}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div>
                        <label for="edit_radius" class="block text-sm font-medium text-gray-700">Radius (for Cylindrical)</label>
                        <input type="number" id="edit_radius" value="${component.radius || 1}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                `;
            } else if (component.type === 'pump') {
                propsContainer.innerHTML = `
                    <div>
                        <label for="edit_maxFlowRate" class="block text-sm font-medium text-gray-700">Max Flow Rate (m³/s)</label>
                        <input type="number" id="edit_maxFlowRate" value="${component.maxFlowRate || 0.5}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                `;
            }

            document.getElementById('editModal').style.display = 'block';
            closeSelectionModal();
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function saveComponentChanges() {
            const oldId = document.getElementById('originalComponentId').value;
            const newId = document.getElementById('editComponentId').value;

            if (oldId !== newId && network.components.some(c => c.id === newId)) {
                console.error("Component ID already exists!");
                return;
            }

            const component = network.components.find(c => c.id === oldId);
            if (!component) return;

            // Update physical properties
            if (component.type === 'tank') {
                component.maxLevel = parseFloat(document.getElementById('edit_maxLevel').value);
                component.radius = parseFloat(document.getElementById('edit_radius').value);
            } else if (component.type === 'pump') {
                component.maxFlowRate = parseFloat(document.getElementById('edit_maxFlowRate').value);
            }
            
            // Update ID and all references if it changed
            if (oldId !== newId) {
                component.id = newId;
                network.pipes.forEach(p => {
                    if (p.from === oldId) p.from = newId;
                    if (p.to === oldId) p.to = newId;
                });
                [...controlActions, ...conditionalActions, ...attackScenarios].forEach(action => {
                    if (action.componentId === oldId) action.componentId = newId;
                    if (action.source && action.source.componentId === oldId) action.source.componentId = newId;
                    if (action.target && action.target.componentId === oldId) action.target.componentId = newId;
                });
            }

            // Refresh everything
            updateVisualization();
            updateAllDropdowns();
            updateInitialConditions();
            updatePipeList();
            updateControlActionsTable();
            updateConditionalActionsTable();
            updateAttacksTable();
            resetAnalysisTab();
            closeEditModal();
        }
        
        function openEditTimedActionModal(index) {
            const action = controlActions[index];
            if (!action) return;

            document.getElementById('editControlActionIndex').value = index;
            document.getElementById('editControlTime').value = action.time;
            document.getElementById('editControlComponent').value = action.componentId;
            document.getElementById('editControlAction').value = action.actionType;

            updateEditControlActionParams(action.actionType, action.params);

            document.getElementById('editTimedActionModal').style.display = 'block';
        }

        function closeEditTimedActionModal() {
            document.getElementById('editTimedActionModal').style.display = 'none';
        }
        
        function updateEditControlActionParams(actionType, params = {}) {
            const paramsDiv = document.getElementById('editControlActionParams');
            actionType = actionType || document.getElementById('editControlAction').value;

            if (actionType === 'set_pump_power') {
                paramsDiv.innerHTML = `<label for="edit_pumpPower" class="block text-sm font-medium text-gray-700">Power (%)</label>
                                       <input type="number" id="edit_pumpPower" value="${params.power || 100}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="0" max="100">`;
            } else if (actionType === 'set_valve_state') {
                paramsDiv.innerHTML = `<label for="edit_valveState" class="block text-sm font-medium text-gray-700">State</label>
                                       <select id="edit_valveState" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                           <option value="open" ${params.state === 'open' ? 'selected' : ''}>Open</option>
                                           <option value="closed" ${params.state === 'closed' ? 'selected' : ''}>Closed</option>
                                       </select>`;
            }
        }
        
        function saveTimedActionChanges() {
            const index = document.getElementById('editControlActionIndex').value;
            if (index === '' || !controlActions[index]) return;

            const actionType = document.getElementById('editControlAction').value;
            let params = {};
            if (actionType === 'set_pump_power') {
                params.power = document.getElementById('edit_pumpPower').value;
            } else if (actionType === 'set_valve_state') {
                params.state = document.getElementById('edit_valveState').value;
            }

            controlActions[index] = {
                time: parseInt(document.getElementById('editControlTime').value),
                componentId: document.getElementById('editControlComponent').value,
                actionType: actionType,
                params: params
            };

            controlActions.sort((a, b) => a.time - b.time);
            updateControlActionsTable();
            closeEditTimedActionModal();
        }

        function renderAnalysisCharts() {
            const componentId = document.getElementById('analysisComponent').value;
            if (!componentId || !lastSimulationResults) return;

            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];

            const chartsContainer = document.getElementById('charts-container');
            chartsContainer.innerHTML = '';

            const timeData = lastSimulationResults.map(d => d.time);
            const parameters = ['waterLevel', 'waterAmount', 'power', 'temperature', 'ph', 'o2', 'bodn', 'nitrate', 'co2'];
            const units = {
                waterLevel: '(m)',
                waterAmount: '(m³)',
                power: '(%)',
                temperature: '(°C)',
                ph: '(pH)',
                o2: '(mg/L)',
                bodn: '(mg/L)',
                nitrate: '(mg/L)',
                co2: '(mg/L)'
            };
            
            const annotations = {};

            attackScenarios.forEach((attack, i) => {
                const attackTime = attack.time !== undefined ? attack.time : attack.startTime;
                const attackLabel = `${attack.type} on ${attack.componentId}`;
                
                // Check if attack has duration (data poisoning, DDoS, etc.)
                if (attack.duration && attack.duration > 0) {
                    annotations[`attack_box_${i}`] = {
                        type: 'box', 
                        xMin: attackTime, 
                        xMax: attackTime + attack.duration,
                        backgroundColor: 'rgba(255, 99, 132, 0.15)', 
                        borderColor: 'rgba(255, 99, 132, 1)', 
                        borderWidth: 1,
                        label: { 
                            content: `${attackLabel} (${attack.duration}s)`, 
                            display: true, 
                            position: 'start',
                            backgroundColor: 'rgba(255, 99, 132, 0.9)',
                            color: 'white',
                            font: { size: 10 }
                        }
                    };
                } else {
                    // Instant attacks (chemical dosing, physical damage, etc.)
                    annotations[`attack_line_${i}`] = {
                        type: 'line', 
                        xMin: attackTime, 
                        xMax: attackTime,
                        borderColor: 'rgb(255, 99, 132)', 
                        borderWidth: 2,
                        label: { 
                            content: attackLabel, 
                            display: true, 
                            position: 'start', 
                            backgroundColor: 'rgba(255, 99, 132, 0.8)', 
                            color: 'white' 
                        }
                    };
                }
            });

            controlActions.filter(a => a.componentId === componentId).forEach((action, i) => {
                let label = '';
                if(action.actionType === 'set_pump_power') label = `Pump Power: ${action.params.power}%`;
                if(action.actionType === 'set_valve_state') label = `Valve: ${action.params.state}`;

                annotations[`control_${i}`] = {
                    type: 'line', xMin: action.time, xMax: action.time,
                    borderColor: 'rgb(75, 192, 192)', borderDash: [6, 6], borderWidth: 2,
                    label: { content: label, display: true, position: 'end', backgroundColor: 'rgba(75, 192, 192, 0.8)', color: 'white' }
                };
            });


            parameters.forEach(param => {
                const comp = network.components.find(c => c.id === componentId);
                const dataKey = `${componentId}_${param}`;

                if (!lastSimulationResults[0].hasOwnProperty(dataKey)) return;

                const chartData = lastSimulationResults.map(d => d[dataKey]);
                
                const canvasContainer = document.createElement('div');
                canvasContainer.className = 'bg-gray-50 p-4 rounded-lg';
                const canvas = document.createElement('canvas');
                canvasContainer.appendChild(canvas);
                chartsContainer.appendChild(canvasContainer);

                const newChart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: timeData,
                        datasets: [{
                            label: `${componentId} - ${param}`,
                            data: chartData,
                            borderColor: 'rgb(59, 130, 246)',
                            tension: 0.1,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        scales: { 
                            x: { title: { display: true, text: 'Time (s)' } },
                            y: { title: { display: true, text: `${param.charAt(0).toUpperCase() + param.slice(1)} ${units[param] || ''}` } }
                        },
                        plugins: {
                            title: { display: true, text: `${param.charAt(0).toUpperCase() + param.slice(1)} Over Time` },
                            annotation: { annotations: annotations }
                        }
                    }
                });
                activeCharts.push(newChart);
            });
        }

        // --- Simulation Engine ---
        function startSimulation() {
            console.log("Starting simulation...");
            const duration = parseInt(document.getElementById('simDuration').value);
            const ambientTemp = parseFloat(document.getElementById('ambientTemp').value);
            const timeStep = 1;
            let simulationData = [];

            document.querySelectorAll('#initial-conditions-container input').forEach(input => {
                const comp = network.components.find(c => c.id === input.dataset.id);
                if (comp && comp.hasOwnProperty(input.dataset.param)) {
                    comp[input.dataset.param] = parseFloat(input.value);
                }
            });

            const progressBar = document.getElementById('progress-bar');
            const progressContainer = document.getElementById('simulation-progress');
            progressContainer.style.display = 'block';

            let simNetwork = JSON.parse(JSON.stringify(network));
            
            for (let t = 0; t <= duration; t += timeStep) {
                // Apply timed controls
                controlActions.filter(a => a.time === t).forEach(action => {
                    const comp = simNetwork.components.find(c => c.id === action.componentId);
                    if (comp) {
                        if (action.actionType === 'set_pump_power') comp.power = parseFloat(action.params.power);
                        if (action.actionType === 'set_valve_state') comp.state = action.params.state;
                    }
                });
                
                // Apply conditional actions to set pump states for this step
                conditionalActions.forEach(rule => {
                    const sourceComp = simNetwork.components.find(c => c.id === rule.source.componentId);
                    if(!sourceComp) return;

                    // Use poisoned reading if available, otherwise use real value
                    let currentValue = sourceComp[rule.source.value];
                    if (sourceComp.poisonedReadings && sourceComp.poisonedReadings[rule.source.value] !== undefined) {
                        const poisonData = sourceComp.poisonedReadings[rule.source.value];
                        // Check if the poisoning is still active
                        if (poisonData.endTime && t <= poisonData.endTime) {
                            currentValue = poisonData.value;
                        }
                    }
                    
                    let conditionMet = false;
                    switch(rule.condition.operator) {
                        case '>': if (currentValue > rule.condition.threshold) conditionMet = true; break;
                        case '<': if (currentValue < rule.condition.threshold) conditionMet = true; break;
                        case '==': if (currentValue == rule.condition.threshold) conditionMet = true; break;
                    }

                    if (conditionMet) {
                        const targetComp = simNetwork.components.find(c => c.id === rule.target.componentId);
                        if (targetComp && !targetComp.stuck) {
                            if(rule.target.actionType === 'set_pump_power') targetComp.power = parseFloat(rule.target.params.power);
                            if(rule.target.actionType === 'emergency_stop') targetComp.power = 0;
                            if(rule.target.actionType === 'emergency_close') targetComp.isOpen = false;
                            if(rule.target.actionType === 'pressure_relief') targetComp.isOpen = true;
                            if(rule.target.actionType === 'reduce_power') targetComp.power = Math.max(0, targetComp.power - parseFloat(rule.target.params.power || 50));
                            if(rule.target.actionType === 'increase_power') targetComp.power = Math.min(100, targetComp.power + parseFloat(rule.target.params.power || 100));
                        }
                    }
                });
                
                // Apply attacks
                 attackScenarios.filter(a => a.time === t).forEach(attack => {
                   const comp = simNetwork.components.find(c => c.id === attack.componentId);
                   if (!comp) return;
                   switch(attack.type) {
                       case 'chemical_dosing':
                           // Simplified pH change
                           if (attack.chemicalType === 'acid') comp.ph -= 1.5;
                           if (attack.chemicalType === 'base') comp.ph += 1.5;
                           comp.ph = Math.max(0, Math.min(14, comp.ph)); // Clamp pH between 0 and 14
                           break;
                       case 'chemical_interference':
                           // Modify specific chemical parameters
                           if (attack.chemical === 'O2') comp.o2 += attack.amount;
                           if (attack.chemical === 'BODn') comp.bodn += attack.amount;
                           if (attack.chemical === 'nitrate') comp.nitrate += attack.amount;
                           if (attack.chemical === 'CO2') comp.co2 += attack.amount;
                           // Ensure values stay within reasonable bounds
                           comp.o2 = Math.max(0, Math.min(15, comp.o2));
                           comp.bodn = Math.max(0, Math.min(10, comp.bodn));
                           comp.nitrate = Math.max(0, Math.min(5, comp.nitrate));
                           comp.co2 = Math.max(0, Math.min(10, comp.co2));
                           break;
                       case 'physical_damage':
                           // Apply physical damage effects
                           if (attack.damageType === 'pump_failure') {
                               comp.power = 0; // Pump stops working
                               comp.efficiency = 0;
                           }
                           if (attack.damageType === 'valve_stuck') {
                               comp.isOpen = false; // Valve gets stuck closed
                               comp.flowRate = 0;
                           }
                           if (attack.damageType === 'leak') {
                               // Simulate water loss over time
                               if (comp.type === 'tank') {
                                   comp.waterAmount *= 0.95; // 5% water loss
                               }
                           }
                           break;
                       case 'data_poisoning':
                           // Store poisoned sensor readings with duration information
                           if (!comp.poisonedReadings) comp.poisonedReadings = {};
                           comp.poisonedReadings[attack.poisonType] = {
                               value: attack.value,
                               startTime: attack.time,
                               endTime: attack.time + attack.duration
                           };
                           break;
                   }
                });

                // Clear expired data poisoning attacks
                simNetwork.components.forEach(comp => {
                    if (comp.poisonedReadings) {
                        Object.keys(comp.poisonedReadings).forEach(sensorType => {
                            const poisonData = comp.poisonedReadings[sensorType];
                            if (poisonData.endTime && t > poisonData.endTime) {
                                delete comp.poisonedReadings[sensorType];
                            }
                        });
                    }
                });

                // --- Physics & Chemistry Simulation Step ---
                
                // 1. Handle water transfer
                simNetwork.components.filter(c => c.type === 'pump').forEach(pump => {
                    if (pump.power > 0) {
                        const inPipe = simNetwork.pipes.find(p => p.to === pump.id);
                        const outPipe = simNetwork.pipes.find(p => p.from === pump.id);

                        if (inPipe && outPipe) {
                            const sourceTank = simNetwork.components.find(c => c.id === inPipe.from);
                            const destTank = simNetwork.components.find(c => c.id === outPipe.to);

                            if (sourceTank && destTank) {
                                const flowAmount = (pump.power / 100) * pump.maxFlowRate * timeStep;
                                if (sourceTank.waterAmount >= flowAmount) {
                                    // Average the chemical properties of the mixed water
                                    const totalAmountInDest = destTank.waterAmount + flowAmount;
                                    if (totalAmountInDest > 0) {
                                        ['temperature', 'ph', 'o2', 'bodn', 'nitrate', 'co2'].forEach(param => {
                                            const weightedAvg = ((destTank[param] * destTank.waterAmount) + (sourceTank[param] * flowAmount)) / totalAmountInDest;
                                            destTank[param] = weightedAvg;
                                        });
                                    }

                                    sourceTank.waterAmount -= flowAmount;
                                    destTank.waterAmount += flowAmount;
                                }
                            }
                        }
                    }
                });
                
                // 2. Update all tank levels and apply thermal exchange
                simNetwork.components.filter(c => c.type === 'tank').forEach(tank => {
                    let area;
                    if (tank.shape === 'rectangular') {
                        area = tank.width * tank.height;
                    } else {
                        // Default to cylindrical
                        area = Math.PI * tank.radius * tank.radius;
                    }
                    tank.waterAmount = Math.max(0, tank.waterAmount); // Ensure not negative
                    tank.waterLevel = tank.waterAmount / area;
                    tank.waterLevel = Math.min(tank.waterLevel, tank.maxLevel); // Cap at max level

                    // Thermal exchange with ambient temperature
                    const tempDiff = ambientTemp - tank.temperature;
                    tank.temperature += tempDiff * 0.001; // 0.001 is a thermal exchange coefficient
                });


                // --- Record Data Step ---
                let stepRecord = { time: t };
                simNetwork.components.forEach(comp => {
                    Object.keys(comp).forEach(key => {
                        if (typeof comp[key] === 'number') {
                            // Check if this value is being poisoned
                            let valueToRecord = comp[key];
                            if (comp.poisonedReadings && comp.poisonedReadings[key] !== undefined) {
                                const poisonData = comp.poisonedReadings[key];
                                if (poisonData.endTime && t <= poisonData.endTime) {
                                    valueToRecord = poisonData.value;
                                }
                            }
                            stepRecord[`${comp.id}_${key}`] = valueToRecord;
                        }
                    });
                });
                
                simulationData.push(stepRecord);
                progressBar.style.width = `${(t / duration) * 100}%`;
            }

            console.log("Simulation finished.");
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
            
            lastSimulationResults = simulationData;
            document.getElementById('tab-btn-analysis').disabled = false;
            document.getElementById('analysis-prompt').style.display = 'none';
            document.getElementById('analysis-content').style.display = 'block';
            document.getElementById('exportResultsBtn').disabled = false;
            updateAllDropdowns();
            renderAnalysisCharts();
        }

        function exportResults() {
            if (!lastSimulationResults || lastSimulationResults.length === 0) {
                console.log("No simulation data to export.");
                return;
            }
            const csv = Papa.unparse(lastSimulationResults);
            const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `simulation_results_${new Date().toISOString().replace(/:/g, '-')}.csv`;
            a.click();
            URL.revokeObjectURL(a.href);
        }
    </script>
    
    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-8">
        <div class="container mx-auto px-4">
            <div class="text-center">
                <p class="text-sm text-gray-300 mb-2">
                    Developed by 
                    <a href="https://www.linkedin.com/in/oguzyardimci/" target="_blank" class="text-blue-400 hover:text-blue-300 underline">Mehmet Oguz Yardimci</a> 
                    @ 
                    <a href="https://ai.bse.vt.edu/" target="_blank" class="text-blue-400 hover:text-blue-300 underline">A3 Lab</a>, 
                    and 
                    <a href="https://ai.bse.vt.edu/ACWA_Lab.html" target="_blank" class="text-blue-400 hover:text-blue-300 underline">ACWA Lab</a>
                </p>
                <p class="text-xs text-gray-400">
                    Virginia Polytechnic Institute and State University
                </p>
            </div>
        </div>
    </footer>
</body>
</html>